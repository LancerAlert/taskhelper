<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}"
      th:with="title='依頼一覧 - TaskHelper | 近所の信頼できる代行サービス'">

<!-- Main Content -->
<th:block layout:fragment="content">

  <!-- Hero Section -->
  <section class="text-white py-32 relative overflow-hidden">
    <div class="absolute inset-0 w-full h-full bg-gradient-to-br from-gray-900 via-blue-900 to-gray-900"></div>
    <div class="max-w-4xl mx-auto px-4 text-center relative z-10">
      <h1 class="text-5xl font-bold mb-6 hero-title">
        依頼一覧
      </h1>
      <p class="text-xl mb-8 hero-subtitle">
        お近くの代行依頼を見つけて、お手伝いしませんか？
      </p>
      <div class="space-x-4 hero-buttons">
        <a th:href="@{/tasks/create}" class="bg-white text-gray-800 px-8 py-3 rounded-lg font-semibold hover:bg-gray-100 hover:shadow-lg hover:-translate-y-1 transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-white/50 inline-block">
          依頼を投稿
        </a>
        <a th:href="@{/helper/onboarding}" class="bg-transparent border-2 border-white text-white px-8 py-3 rounded-lg font-semibold hover:bg-white hover:text-gray-800 hover:shadow-lg hover:-translate-y-1 backdrop-blur-sm transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-white/50 inline-block">
          ヘルパー登録
        </a>
      </div>
    </div>
  </section>

  <!-- Task List Container -->
  <section class="py-12" x-data="taskListData()">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">

      <!-- Search Bar (Top Section) -->
      <div class="bg-white rounded-2xl border p-6 mb-6">
        <div class="max-w-4xl mx-auto">
          <div class="flex gap-3">
            <!-- Search Filter Dropdown (Left Most) -->
            <div class="relative">
              <select x-model="searchFilter"  
                      class="appearance-none px-4 py-4 pr-10 rounded-xl bg-gray-50/50 focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300 text-gray-700 border border-gray-300 whitespace-nowrap">
                <option value="all">すべて</option>
                <option value="title">タイトル</option>
                <option value="description">説明</option>
                <option value="tags">タグ</option>
                <option value="location">地域</option>
              </select>
              <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                <i class="fas fa-chevron-down text-gray-500 text-sm"></i>
              </div>
            </div>
            
            <!-- Main Search Input -->
            <div class="relative flex-1">
              <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                <i class="fas fa-search text-gray-400" aria-hidden="true"></i>
              </div>
              <input type="text" x-model="searchTerm"  placeholder="キーワードで依頼を検索..."
                     class="w-full pl-12 pr-4 py-4 border border-gray-300 rounded-xl bg-gray-50/50 focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300 text-lg">
            </div>
          </div>
          
          <!-- Quick Search and Stats (Single Row) -->
          <div class="flex flex-wrap items-center justify-between mt-4 gap-2">
            <!-- Quick Search Buttons and Clear Button (Left Side) -->
            <div class="flex flex-wrap items-center gap-2">
              <button @click="quickSearch('urgent')" 
                      :class="{'bg-red-100 text-red-700 border-red-300': quickSearchActive === 'urgent'}"
                      class="px-3 py-2 rounded-lg border border-gray-300 text-sm font-medium hover:bg-gray-50 transition-all duration-300 whitespace-nowrap">
                <i class="fas fa-exclamation-triangle mr-1 text-xs"></i>
                緊急
              </button>
              <button @click="quickSearch('today')" 
                      :class="{'bg-blue-100 text-blue-700 border-blue-300': quickSearchActive === 'today'}"
                      class="px-3 py-2 rounded-lg border border-gray-300 text-sm font-medium hover:bg-gray-50 transition-all duration-300 whitespace-nowrap">
                <i class="fas fa-clock mr-1 text-xs"></i>
                今日
              </button>
              <button @click="quickSearch('high-pay')" 
                      :class="{'bg-green-100 text-green-700 border-green-300': quickSearchActive === 'high-pay'}"
                      class="px-3 py-2 rounded-lg border border-gray-300 text-sm font-medium hover:bg-gray-50 transition-all duration-300 whitespace-nowrap">
                <i class="fas fa-yen-sign mr-1 text-xs"></i>
                高報酬
              </button>
              <!-- Search Clear Button -->
              <button @click="clearSearch()" x-show="searchTerm !== '' || searchFilter !== 'all' || quickSearchActive !== ''" 
                      class="clear-btn">
                <i class="fas fa-times text-xs"></i>
                クリア
              </button>
            </div>
            
            <!-- Search Stats (Right Side) -->
            <div class="flex items-center gap-2 text-sm text-gray-500">
              <span x-text="`${filteredTasks.length}件の依頼`" class="whitespace-nowrap"></span>
              <span x-show="searchTerm !== ''" class="flex items-center gap-1">
                <i class="fas fa-search text-xs"></i>
                <span x-text="`「${searchTerm}」`" class="max-w-20 truncate"></span>
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Filters Section -->
      <div class="bg-white rounded-2xl border p-6 mb-8">
        <div class="space-y-3">
          <!-- Category Filters (First Row) -->
          <div class="flex flex-wrap justify-center gap-2">
            <template x-for="category in categories" :key="category.id">
              <button @click="selectCategory(category.id)" 
                      :class="{
                        'bg-blue-100 text-blue-700 border-blue-300': activeCategory === category.id,
                        'hover:bg-gray-50': activeCategory !== category.id
                      }"
                      class="px-4 py-2 rounded-lg border border-gray-300 text-sm font-medium transition-all duration-300 whitespace-nowrap">
                <i :class="category.icon + ' mr-1'" aria-hidden="true" x-show="category.icon"></i>
                <span x-text="category.name"></span>
              </button>
            </template>
          </div>

          <!-- Other Filters (Second Row) -->
          <div class="flex flex-wrap justify-center items-center gap-3">
            <!-- Location Filter -->
            <div class="relative">
              <select x-model="selectedLocation"  
                      class="appearance-none px-3 py-2 pr-8 rounded-lg bg-gray-50/50 focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300 text-gray-700 text-sm border border-gray-300">
                <option value="">エリア</option>
                <option value="shibuya">渋谷区</option>
                <option value="shinjuku">新宿区</option>
                <option value="minato">港区</option>
                <option value="chiyoda">千代田区</option>
              </select>
              <div class="absolute inset-y-0 right-0 pr-2 flex items-center pointer-events-none">
                <i class="fas fa-chevron-down text-gray-500 text-xs"></i>
              </div>
            </div>

            <!-- Price Filter -->
            <div class="relative">
              <select x-model="priceRange"  
                      class="appearance-none px-3 py-2 pr-8 rounded-lg bg-gray-50/50 focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300 text-gray-700 text-sm border border-gray-300">
                <option value="">価格</option>
                <option value="0-2000">¥2,000以下</option>
                <option value="2000-5000">¥2,000-5,000</option>
                <option value="5000-10000">¥5,000-10,000</option>
                <option value="10000+">¥10,000以上</option>
              </select>
              <div class="absolute inset-y-0 right-0 pr-2 flex items-center pointer-events-none">
                <i class="fas fa-chevron-down text-gray-500 text-xs"></i>
              </div>
            </div>

            <!-- Time Filter -->
            <div class="relative">
              <select x-model="timeFilter"  
                      class="appearance-none px-3 py-2 pr-8 rounded-lg bg-gray-50/50 focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300 text-gray-700 text-sm border border-gray-300">
                <option value="">時間</option>
                <option value="today">今日</option>
                <option value="tomorrow">明日</option>
                <option value="this-week">今週</option>
                <option value="flexible">相談可</option>
              </select>
              <div class="absolute inset-y-0 right-0 pr-2 flex items-center pointer-events-none">
                <i class="fas fa-chevron-down text-gray-500 text-xs"></i>
              </div>
            </div>

            <!-- Sort Filter -->
            <div class="relative">
              <select x-model="sortBy" 
                      class="appearance-none px-3 py-2 pr-8 rounded-lg bg-gray-50/50 focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300 text-gray-700 text-sm border border-gray-300">
                <option value="newest">最新順</option>
                <option value="distance">距離順</option>
                <option value="price-high">報酬高順</option>
                <option value="price-low">報酬安順</option>
              </select>
              <div class="absolute inset-y-0 right-0 pr-2 flex items-center pointer-events-none">
                <i class="fas fa-sort text-gray-500 text-xs"></i>
              </div>
            </div>

            <!-- Clear Filters Button -->
            <button @click="clearAllFilters()" 
                    class="clear-btn"
                    :class="hasActiveFilters ? 'visible' : 'hidden'">
              <i class="fas fa-times text-xs"></i>
              クリア
            </button>
          </div>
        </div>
      </div>

      <!-- Task Grid -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" x-show="filteredTasks.length > 0">
        
        <!-- Enhanced Task Cards with Mobile-Optimized Design -->
        <template x-for="task in filteredTasks" :key="task.id">
          <div class="service-card task-card bg-white rounded-2xl shadow-lg border border-gray-100 transition-all duration-300 hover:shadow-xl cursor-pointer overflow-hidden" 
               :data-category="task.category" 
               :data-location="task.location" 
               @click="navigateToTask(task.id)">
            <div class="p-6 sm:p-4">
              <!-- Header -->
              <div class="flex items-start justify-between mb-4 flex-nowrap">
                <div class="flex items-center space-x-3">
                  <div class="w-12 h-12 sm:w-8 sm:h-8 rounded-full flex items-center justify-center" :class="task.iconBg">
                    <i :class="task.icon + ' text-xl sm:text-lg ' + task.iconColor"></i>
                  </div>
                  <div>
                    <h3 class="font-semibold text-gray-900" x-text="task.title"></h3>
                    <p class="text-sm text-gray-500 relative-time" :data-time="task.time" x-text="task.timeDisplay"></p>
                  </div>
                </div>
                <span class="status-badge px-3 py-1 rounded-full text-xs font-medium whitespace-nowrap flex-shrink-0" 
                      :class="task.statusClass" x-text="task.status"></span>
              </div>

              <!-- Description -->
              <p class="text-gray-600 mb-4 line-clamp-2" x-text="task.description"></p>

              <!-- Details -->
              <div class="space-y-3 mb-4">
                <div class="flex items-center text-sm text-gray-600">
                  <i class="fas fa-map-marker-alt w-4 h-4 mr-2"></i>
                  <span x-text="task.locationName"></span>
                </div>
                <div class="flex items-center text-sm text-gray-600">
                  <i class="fas fa-yen-sign w-4 h-4 mr-2"></i>
                  <span x-text="'¥' + task.price"></span>
                </div>
                <div class="flex items-center text-sm text-gray-600">
                  <i class="fas fa-clock w-4 h-4 mr-2"></i>
                  <span x-text="task.deadline"></span>
                </div>
              </div>

              <!-- Tags -->
              <div class="flex flex-wrap gap-2 mb-4">
                <template x-for="tag in task.tags" :key="tag">
                  <span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs" x-text="tag"></span>
                </template>
              </div>

              <!-- Actions -->
              <div class="flex gap-2">
                <button @click.stop="applyToTask($event, task.id)" 
                        :disabled="task.status === '完了'"
                        class="flex-1 px-4 py-2 rounded-lg font-semibold transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-blue-300"
                        :class="task.status === '完了' ? 'bg-gray-400 text-white cursor-not-allowed' : 'bg-blue-600 text-white hover:bg-blue-700 hover:shadow-lg'">
                  <span x-text="task.status === '完了' ? '完了済み' : '応募する'"></span>
                </button>
                <button @click.stop="toggleFavorite($event, task.id)" 
                        class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-blue-300">
                  <i class="fas fa-heart text-gray-400"></i>
                </button>
              </div>
            </div>
          </div>
        </template>

      </div>

      <!-- Empty State -->
      <div class="text-center py-16" x-show="filteredTasks.length === 0">
        <div class="max-w-md mx-auto">
          <i class="fas fa-search text-6xl text-gray-300 mb-6"></i>
          <h3 class="text-xl font-semibold text-gray-700 mb-2">お探しの依頼が見つかりません</h3>
          <p class="text-gray-500 mb-6">検索条件を変更するか、新しい依頼を投稿してみてください。</p>
          <a th:href="@{/tasks/create}" class="inline-flex items-center px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-blue-300">
            <i class="fas fa-plus mr-2"></i>
            依頼を投稿する
          </a>
        </div>
      </div>

      <!-- Load More Button -->
      <div class="text-center mt-12">
        <button @click="loadMore()" class="load-more-btn bg-white border-2 border-blue-600 text-blue-600 px-8 py-3 rounded-full font-semibold transition-all duration-300 focus:outline-none shadow-md">
          <i class="fas fa-plus mr-2"></i>
          さらに読み込む
        </button>
      </div>
    </div>
  </section>

  <!-- External CSS and JavaScript files -->
  <link rel="stylesheet" th:href="@{/css/task-list.css}">
  <script th:src="@{/js/task-list.js}"></script>

</th:block>
</html>