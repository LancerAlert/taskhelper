<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}"
      th:with="title='マイタスク - TaskHelper | 近所の信頼できる代行サービス'">

<!-- Main Content -->
<th:block layout:fragment="content">

  <!-- Hero Section with Statistics -->
  <section class="bg-gradient-to-r from-gray-900 via-blue-900 to-gray-900 py-16">
    <div class="max-w-7xl mx-auto px-4">
      <!-- Page Header -->
      <div class="text-center text-white mb-12">
        <div class="w-24 h-24 bg-gradient-to-br from-white/20 to-white/10 rounded-full flex items-center justify-center text-white text-4xl font-bold shadow-2xl backdrop-blur-sm border border-white/20 mx-auto mb-6">
          <i class="fas fa-user-circle"></i>
        </div>
        <h1 class="text-4xl lg:text-5xl font-bold mb-4">マイダッシュボード</h1>
        <p class="text-xl opacity-90 max-w-2xl mx-auto">あなたの活動状況と実績を一目で確認</p>
      </div>

      <!-- Requester Stats Grid -->
      <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 lg:gap-6" x-data="{
        stats: {
          postedTasks: 8,
          completedTasks: 12,
          savedHours: 150,
          avgSatisfaction: 4.8
        }
      }">
        <!-- Posted Tasks -->
        <div class="bg-white/10 backdrop-blur-sm rounded-2xl p-4 lg:p-6 border border-white/20 hover:bg-white/15 transition-all duration-300">
          <div class="flex flex-col items-center text-center">
            <i class="fas fa-clipboard-list text-2xl lg:text-3xl text-blue-300 mb-2"></i>
            <p class="text-2xl lg:text-3xl font-bold text-white" x-text="stats.postedTasks"></p>
            <p class="text-sm lg:text-base text-white/80">投稿した依頼</p>
          </div>
        </div>

        <!-- Completed Tasks -->
        <div class="bg-white/10 backdrop-blur-sm rounded-2xl p-4 lg:p-6 border border-white/20 hover:bg-white/15 transition-all duration-300">
          <div class="flex flex-col items-center text-center">
            <i class="fas fa-check-circle text-2xl lg:text-3xl text-green-300 mb-2"></i>
            <p class="text-2xl lg:text-3xl font-bold text-white" x-text="stats.completedTasks"></p>
            <p class="text-sm lg:text-base text-white/80">完了した依頼</p>
          </div>
        </div>

        <!-- Saved Hours -->
        <div class="bg-white/10 backdrop-blur-sm rounded-2xl p-4 lg:p-6 border border-white/20 hover:bg-white/15 transition-all duration-300">
          <div class="flex flex-col items-center text-center">
            <i class="fas fa-clock text-2xl lg:text-3xl text-yellow-300 mb-2"></i>
            <p class="text-xl lg:text-2xl font-bold text-white"><span x-text="stats.savedHours"></span>時間</p>
            <p class="text-sm lg:text-base text-white/80">節約した時間</p>
          </div>
        </div>

        <!-- Average Satisfaction -->
        <div class="bg-white/10 backdrop-blur-sm rounded-2xl p-4 lg:p-6 border border-white/20 hover:bg-white/15 transition-all duration-300">
          <div class="flex flex-col items-center text-center">
            <i class="fas fa-star text-2xl lg:text-3xl text-orange-300 mb-2"></i>
            <p class="text-2xl lg:text-3xl font-bold text-white"><span x-text="stats.avgSatisfaction"></span>/5.0</p>
            <p class="text-sm lg:text-base text-white/80">平均満足度</p>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="flex justify-center mt-8">
        <a th:href="@{/tasks/create}" 
           class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-8 py-4 rounded-xl font-semibold hover:from-blue-600 hover:to-blue-700 hover:scale-105 transition-all duration-300 shadow-lg text-center text-lg">
          <i class="fas fa-plus mr-2"></i>新しい依頼を作成
        </a>
      </div>
    </div>
  </section>

  <!-- Main Content Area -->
  <section class="py-12 -mt-6" x-data="myTasksManager()">
    <div class="max-w-7xl mx-auto px-4">

      <!-- Tab Navigation (Requester Only) -->
      <div class="bg-white rounded-2xl shadow-lg p-2 mb-8">
        <div class="grid grid-cols-2 gap-2">
          <button 
            @click="activeView = 'posted'"
            :class="activeView === 'posted' ? 'bg-blue-500 text-white shadow-md' : 'text-gray-600 hover:text-gray-800 hover:bg-gray-50'"
            class="px-4 py-3 rounded-xl font-semibold transition-all duration-300 text-center"
          >
            <i class="fas fa-clipboard-list mr-2"></i>
            <span class="hidden sm:inline">投稿した</span>依頼
          </button>
          <button 
            @click="activeView = 'completed'"
            :class="activeView === 'completed' ? 'bg-green-500 text-white shadow-md' : 'text-gray-600 hover:text-gray-800 hover:bg-gray-50'"
            class="px-4 py-3 rounded-xl font-semibold transition-all duration-300 text-center"
          >
            <i class="fas fa-check-circle mr-2"></i>
            <span class="hidden sm:inline">完了した</span>依頼
          </button>
        </div>
      </div>

      <!-- Status Filter Tabs (context-aware) -->
      <div class="mb-6">
        <div class="flex flex-wrap gap-2 justify-center lg:justify-start">
          <button 
            @click="statusFilter = 'all'"
            :class="statusFilter === 'all' ? 'bg-gray-800 text-white' : 'bg-white text-gray-600 hover:bg-gray-50'"
            class="px-4 py-2 rounded-full font-medium transition-all duration-300 shadow-sm border"
          >
            すべて
          </button>
          <!-- Posted tab filters -->
          <button 
            x-show="activeView === 'posted'"
            @click="statusFilter = 'recruiting'"
            :class="statusFilter === 'recruiting' ? 'bg-green-500 text-white' : 'bg-white text-gray-600 hover:bg-gray-50'"
            class="px-4 py-2 rounded-full font-medium transition-all duration-300 shadow-sm border"
          >
            募集中
          </button>
          <button 
            x-show="activeView === 'posted'"
            @click="statusFilter = 'in-progress'"
            :class="statusFilter === 'in-progress' ? 'bg-blue-500 text-white' : 'bg-white text-gray-600 hover:bg-gray-50'"
            class="px-4 py-2 rounded-full font-medium transition-all duration-300 shadow-sm border"
          >
            進行中
          </button>
          <button 
            x-show="activeView === 'posted'"
            @click="statusFilter = 'pending-payment'"
            :class="statusFilter === 'pending-payment' ? 'bg-yellow-500 text-white' : 'bg-white text-gray-600 hover:bg-gray-50'"
            class="px-4 py-2 rounded-full font-medium transition-all duration-300 shadow-sm border"
          >
            入金待ち
          </button>
          <!-- Completed tab filters -->
          <button 
            x-show="activeView === 'completed'"
            @click="statusFilter = 'unrated'"
            :class="statusFilter === 'unrated' ? 'bg-yellow-500 text-white' : 'bg-white text-gray-600 hover:bg-gray-50'"
            class="px-4 py-2 rounded-full font-medium transition-all duration-300 shadow-sm border"
          >
            評価待ち
          </button>
          <button 
            x-show="activeView === 'completed'"
            @click="statusFilter = 'rated'"
            :class="statusFilter === 'rated' ? 'bg-green-500 text-white' : 'bg-white text-gray-600 hover:bg-gray-50'"
            class="px-4 py-2 rounded-full font-medium transition-all duration-300 shadow-sm border"
          >
            評価済み
          </button>
        </div>
      </div>

      <!-- Task Cards Grid -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        
        <!-- Dynamic Task Cards -->
        <template x-for="task in getFilteredTasks()" :key="task.id">
          <div class="bg-white rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 p-6 border border-gray-100"
               x-transition:enter="transition ease-out duration-300"
               x-transition:enter-start="opacity-0 scale-95"
               x-transition:enter-end="opacity-100 scale-100">
            
            <!-- Card Header -->
            <div class="flex justify-between items-start mb-4">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-2">
                  <!-- Status Badge -->
                  <span :class="getStatusBadgeClass(task.status)" class="px-3 py-1 rounded-full text-sm font-medium">
                    <template x-if="task.status === 'recruiting'">
                      <span><i class="fas fa-clock mr-1"></i>募集中</span>
                    </template>
                    <template x-if="task.status === 'in-progress'">
                      <span><i class="fas fa-cog mr-1"></i>進行中</span>
                    </template>
                    <template x-if="task.status === 'pending-payment'">
                      <span><i class="fas fa-credit-card mr-1"></i>入金待ち</span>
                    </template>
                    <template x-if="task.status === 'rated'">
                      <span><i class="fas fa-star mr-1"></i>評価済み</span>
                    </template>
                    <template x-if="task.status === 'unrated'">
                      <span><i class="fas fa-hourglass-half mr-1"></i>評価待ち</span>
                    </template>
                  </span>
                  <!-- Category Badge -->
                  <span :class="'bg-' + (task.category === 'shopping' ? 'green' : task.category === 'cleaning' ? 'blue' : task.category === 'delivery' ? 'orange' : task.category === 'petcare' ? 'purple' : task.category === 'repairs' ? 'red' : 'gray') + '-100 text-' + (task.category === 'shopping' ? 'green' : task.category === 'cleaning' ? 'blue' : task.category === 'delivery' ? 'orange' : task.category === 'petcare' ? 'purple' : task.category === 'repairs' ? 'red' : 'gray') + '-800'" class="px-2 py-1 rounded text-xs">
                    <i :class="getCategoryIcon(task.category)" class="mr-1"></i>
                    <span x-text="task.category === 'shopping' ? '買い物' : task.category === 'cleaning' ? '掃除' : task.category === 'delivery' ? '配送' : task.category === 'petcare' ? 'ペットケア' : task.category === 'repairs' ? '修理' : 'その他'"></span>
                  </span>
                </div>
                <h3 class="text-lg font-bold text-gray-800 mb-1" x-text="task.title"></h3>
                <p class="text-sm text-gray-500" x-text="(task.createdAt || task.completedAt) + (activeView === 'posted' ? 'に投稿' : 'に完了')"></p>
              </div>
              <div class="text-right">
                <p class="text-2xl font-bold" :class="task.status === 'recruiting' ? 'text-blue-600' : 'text-green-600'" x-text="formatPrice(task.price)"></p>
                <template x-if="activeView === 'posted' && task.applicants !== undefined">
                  <p class="text-xs" :class="task.applicants > 0 ? 'text-blue-600 font-semibold' : 'text-gray-500'">
                    <i class="fas fa-users mr-1"></i>応募者 <span x-text="task.applicants"></span>名
                  </p>
                </template>
                <template x-if="activeView === 'completed' && task.rating">
                  <div class="flex items-center justify-end text-yellow-400 text-sm">
                    <i class="fas fa-star"></i>
                    <span class="ml-1 text-gray-600" x-text="task.rating"></span>
                  </div>
                </template>
              </div>
            </div>

            <!-- Card Content -->
            <p class="text-gray-600 text-sm mb-4 line-clamp-2" x-text="task.description || '詳細な説明はまだ追加されていません。'"></p>

            <!-- Card Meta -->
            <div class="flex items-center text-xs text-gray-500 mb-4 space-x-4">
              <span><i class="fas fa-map-marker-alt mr-1"></i><span x-text="task.location"></span></span>
              <template x-if="task.status === 'recruiting'">
                <span><i class="fas fa-users mr-1"></i>募集中</span>
              </template>
              <template x-if="task.status === 'in-progress'">
                <span><i class="fas fa-clock mr-1"></i>作業中</span>
              </template>
              <template x-if="task.status === 'pending-payment'">
                <span><i class="fas fa-credit-card mr-1"></i>支払待ち</span>
              </template>
              <template x-if="task.status === 'rated'">
                <span><i class="fas fa-check-circle mr-1 text-green-500"></i>完了済み</span>
              </template>
            </div>

            <!-- Card Actions -->
            <div class="flex gap-2">
              <!-- Posted tab: Show detail button always -->
              <template x-if="activeView === 'posted'">
                <button class="flex-1 bg-blue-600 text-white py-2.5 px-4 rounded-lg font-semibold hover:bg-blue-700 transition-all duration-200 shadow-sm" @click="viewTaskDetail(task.id)">
                  <i class="fas fa-eye mr-1.5"></i>詳細を見る
                </button>
              </template>
              <!-- Posted tab: Show applicants button only for recruiting status with applicants -->
              <template x-if="activeView === 'posted' && task.status === 'recruiting' && task.applicants > 0">
                <button class="flex-1 border border-gray-300 bg-white text-gray-700 py-2.5 px-4 rounded-lg font-medium hover:bg-gray-50 transition-all duration-200" @click="viewApplicants(task.id)">
                  <i class="fas fa-users mr-1.5"></i>応募者を見る
                </button>
              </template>
              <!-- Posted tab: Show edit button only for recruiting status -->
              <template x-if="activeView === 'posted' && task.status === 'recruiting'">
                <button class="flex-1 border border-gray-300 bg-white text-gray-700 py-2.5 px-4 rounded-lg font-medium hover:bg-gray-50 transition-all duration-200" @click="editTaskWithWarning(task.id, task.applicants)">
                  <i class="fas fa-edit mr-1.5"></i>編集
                  <template x-if="task.applicants > 0">
                    <span class="text-xs text-red-500 block">※応募者リセット</span>
                  </template>
                </button>
              </template>
              <!-- Posted tab: Show message button for in-progress status -->
              <template x-if="activeView === 'posted' && task.status === 'in-progress'">
                <button class="flex-1 border border-gray-300 bg-white text-gray-700 py-2.5 px-4 rounded-lg font-medium hover:bg-gray-50 transition-all duration-200" @click="messageHelper(task.id)">
                  <i class="fas fa-comments mr-1.5"></i>連絡
                </button>
              </template>
              <!-- Posted tab: Show payment button for pending-payment -->
              <template x-if="activeView === 'posted' && task.status === 'pending-payment'">
                <button class="flex-1 bg-green-600 text-white py-2.5 px-4 rounded-lg font-semibold hover:bg-green-700 transition-all duration-200 shadow-sm" @click="makePayment(task.id)">
                  <i class="fas fa-credit-card mr-1.5"></i>入金する
                </button>
              </template>
              <!-- Posted tab: Show delete button only for recruiting status -->
              <template x-if="activeView === 'posted' && task.status === 'recruiting'">
                <button class="px-3 py-2.5 text-red-600 hover:bg-red-50 rounded-lg transition-all duration-200" @click="deleteTask(task.id)" title="削除">
                  <i class="fas fa-trash"></i>
                </button>
              </template>
              <!-- Completed tab: Show rate button for unrated -->
              <template x-if="activeView === 'completed' && task.status === 'unrated'">
                <button class="flex-1 bg-yellow-500 text-white py-2.5 px-4 rounded-lg font-semibold hover:bg-yellow-600 transition-all duration-200 shadow-sm">
                  <i class="fas fa-star mr-1.5"></i>評価する
                </button>
              </template>
              <!-- Completed tab: Show detail button for rated -->
              <template x-if="activeView === 'completed' && task.status === 'rated'">
                <button class="flex-1 bg-blue-600 text-white py-2.5 px-4 rounded-lg font-semibold hover:bg-blue-700 transition-all duration-200 shadow-sm" @click="viewTaskDetail(task.id)">
                  <i class="fas fa-eye mr-1.5"></i>詳細を見る
                </button>
              </template>
            </div>
          </div>
        </template>
        
        <!-- Empty State -->
        <template x-if="getFilteredTasks().length === 0">
          <div class="col-span-full text-center py-12">
            <i class="fas fa-search text-6xl text-gray-300 mb-4"></i>
            <h3 class="text-xl font-semibold text-gray-500 mb-2">該当する依頼がありません</h3>
            <p class="text-gray-400">フィルターを変更するか、新しい依頼を作成してください。</p>
          </div>
        </template>

      </div>

      <!-- Load More Button -->
      <div class="text-center">
        <button class="bg-white border-2 border-gray-300 text-gray-700 px-8 py-3 rounded-full font-semibold hover:bg-gray-50 hover:border-gray-400 hover:scale-105 transition-all duration-300 shadow-sm">
          <i class="fas fa-plus mr-2"></i>さらに表示
        </button>
      </div>

    </div>
  </section>

</th:block>

<!-- Extra Scripts -->
<th:block layout:fragment="extra-scripts">
  <link rel="stylesheet" th:href="@{/css/task/my.css}">
  <script th:src="@{/js/task/my.js}"></script>
</th:block>

</html>