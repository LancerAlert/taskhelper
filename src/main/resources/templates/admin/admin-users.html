<!DOCTYPE html>
<html lang="ja" class="scroll-smooth">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ユーザー管理 - 管理者ダッシュボード | TaskHelper</title>
  
  <!-- CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- CSS Libraries -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  
  <!-- Additional UI Libraries -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.10.1/sweetalert2.min.css" rel="stylesheet">
  
  <!-- Alpine.js -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  
  <!-- Custom CSS -->
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', sans-serif;
    }
    
    .glass-effect {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .admin-header {
      background: linear-gradient(135deg, #1f2937 0%, #374151 50%, #4b5563 100%);
      border-bottom: 3px solid #3b82f6;
    }
    
    .status-active {
      background: #dcfce7;
      color: #166534;
      border: 1px solid #bbf7d0;
    }
    
    .status-suspended {
      background: #fef2f2;
      color: #dc2626;
      border: 1px solid #fecaca;
    }
    
    .status-pending {
      background: #fefbf2;
      color: #d97706;
      border: 1px solid #fed7aa;
    }
    
    .status-verified {
      background: #e0f2fe;
      color: #0369a1;
      border: 1px solid #bae6fd;
    }
    
    .role-admin {
      background: #f3e8ff;
      color: #7c3aed;
      border: 1px solid #e9d5ff;
    }
    
    .role-helper {
      background: #dbeafe;
      color: #2563eb;
      border: 1px solid #bfdbfe;
    }
    
    .role-user {
      background: #f0fdf4;
      color: #16a34a;
      border: 1px solid #bbf7d0;
    }
    
    .user-card {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 0.75rem;
      transition: all 0.2s ease;
    }
    
    .user-card:hover {
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      border-color: #3b82f6;
      transform: translateY(-2px);
    }
    
    .action-button {
      padding: 0.5rem;
      border-radius: 0.375rem;
      transition: all 0.2s ease;
      border: 1px solid transparent;
    }
    
    .action-button:hover {
      transform: scale(1.05);
    }
    
    .action-edit {
      color: #3b82f6;
      background: #eff6ff;
      border-color: #bfdbfe;
    }
    
    .action-suspend {
      color: #dc2626;
      background: #fef2f2;
      border-color: #fecaca;
    }
    
    .action-activate {
      color: #059669;
      background: #ecfdf5;
      border-color: #a7f3d0;
    }
    
    .action-delete {
      color: #7c2d12;
      background: #fef7ed;
      border-color: #fed7aa;
    }
    
    .activity-timeline {
      position: relative;
      padding-left: 2rem;
    }
    
    .activity-timeline::before {
      content: '';
      position: absolute;
      left: 0.5rem;
      top: 0;
      bottom: 0;
      width: 2px;
      background: #e5e7eb;
    }
    
    .activity-item {
      position: relative;
      margin-bottom: 1rem;
    }
    
    .activity-dot {
      position: absolute;
      left: -1.5rem;
      top: 0.5rem;
      width: 0.75rem;
      height: 0.75rem;
      border-radius: 50%;
      border: 2px solid white;
      background: #6b7280;
    }
    
    .activity-dot.login { background: #10b981; }
    .activity-dot.task { background: #3b82f6; }
    .activity-dot.payment { background: #f59e0b; }
    .activity-dot.review { background: #8b5cf6; }
    
    .stats-card {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(248, 250, 252, 0.9));
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }
    
    .filter-tag {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
      transition: all 0.2s ease;
      cursor: pointer;
    }
    
    .filter-tag.active {
      background: #3b82f6;
      color: white;
      transform: scale(1.05);
    }
    
    .filter-tag:not(.active) {
      background: #f8fafc;
      color: #64748b;
      border: 1px solid #e2e8f0;
    }
    
    .filter-tag:not(.active):hover {
      background: #f1f5f9;
      border-color: #cbd5e1;
    }
  </style>
</head>

<body class="bg-gradient-to-br from-blue-50 via-white to-green-50 min-h-screen">

<!-- Navigation -->
<nav class="bg-white shadow-sm fixed top-0 left-0 right-0 z-50">
  <div class="max-w-7xl mx-auto px-4">
    <div class="flex items-center h-16">
      <!-- Logo -->
      <div class="flex items-center space-x-2">
        <i class="fas fa-hands-helping text-2xl text-blue-600" aria-hidden="true"></i>
        <span class="text-xl font-bold text-gray-900">TaskHelper</span>
        <span class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded-full font-medium">ADMIN</span>
      </div>
      
      <!-- Desktop Menu (centered) -->
      <div class="hidden md:flex items-center space-x-8 mx-auto">
        <a href="admin-dashboard.html" class="text-gray-700 hover:text-blue-600 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2 focus:rounded px-2 py-1 no-underline">ダッシュボード</a>
        <a href="admin-users.html" class="text-blue-600 font-medium focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2 focus:rounded px-2 py-1 no-underline">ユーザー管理</a>
        <a href="admin-disputes.html" class="text-gray-700 hover:text-blue-600 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2 focus:rounded px-2 py-1 no-underline">分散解決</a>
        <a href="admin-analytics.html" class="text-gray-700 hover:text-blue-600 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2 focus:rounded px-2 py-1 no-underline">分析</a>
        <a href="admin-content.html" class="text-gray-700 hover:text-blue-600 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2 focus:rounded px-2 py-1 no-underline">コンテンツ</a>
      </div>
      
      <!-- Admin Actions -->
      <div class="hidden md:flex items-center space-x-3">
        <button class="text-gray-600 hover:text-gray-800 p-2 rounded-lg hover:bg-gray-100 transition-colors">
          <i class="fas fa-bell"></i>
        </button>
        <a href="index.html" class="border border-blue-600 text-blue-600 px-4 py-2 rounded-lg font-semibold hover:bg-blue-50 transition-colors">サイトに戻る</a>
      </div>
      
      <!-- Mobile Menu Button -->
      <div class="md:hidden ml-auto">
        <button id="mobile-menu-button" class="text-gray-700 hover:text-blue-600 p-2 transition-all duration-300 ease-in-out" aria-expanded="false">
          <svg class="w-6 h-6 transition-transform duration-300 ease-in-out" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path id="menu-icon" class="transition-opacity duration-300" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
            <path id="close-icon" class="transition-opacity duration-300 opacity-0" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
    </div>
    
    <!-- Mobile Menu -->
    <div id="mobile-menu" class="hidden md:hidden pb-4 transition-all duration-300 ease-in-out transform">
      <div class="flex flex-col space-y-2">
        <a href="admin-dashboard.html" class="block px-3 py-2 text-gray-700 hover:text-blue-600 hover:bg-gray-50 rounded">ダッシュボード</a>
        <a href="admin-users.html" class="block px-3 py-2 text-blue-600 bg-blue-50 rounded font-medium">ユーザー管理</a>
        <a href="admin-disputes.html" class="block px-3 py-2 text-gray-700 hover:text-blue-600 hover:bg-gray-50 rounded">分散解決</a>
        <a href="admin-analytics.html" class="block px-3 py-2 text-gray-700 hover:text-blue-600 hover:bg-gray-50 rounded">分析</a>
        <a href="admin-content.html" class="block px-3 py-2 text-gray-700 hover:text-blue-600 hover:bg-gray-50 rounded">コンテンツ</a>
        <hr class="my-3">
        <a href="index.html" class="block px-3 py-2 text-blue-600 hover:bg-blue-50 rounded">サイトに戻る</a>
      </div>
    </div>
  </div>
</nav>

<!-- Main Content -->
<main class="min-h-screen pt-16" x-data="adminUsersApp()">
  
  <!-- Header -->
  <div class="admin-header text-white py-8">
    <div class="max-w-7xl mx-auto px-4">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-3xl font-bold mb-2">ユーザー管理</h1>
          <p class="text-gray-300">登録ユーザーの管理と監視</p>
        </div>
        <div class="flex items-center space-x-3">
          <button @click="exportUsers()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
            <i class="fas fa-download mr-2"></i>
            エクスポート
          </button>
          <button @click="showBulkActions = !showBulkActions" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
            <i class="fas fa-tasks mr-2"></i>
            一括操作
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Stats Overview -->
  <div class="py-8">
    <div class="max-w-7xl mx-auto px-4">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="stats-card rounded-xl p-6 text-center">
          <div class="text-3xl font-bold text-blue-600 mb-2" x-text="stats.totalUsers"></div>
          <div class="text-gray-600 text-sm">総ユーザー数</div>
          <div class="text-xs text-green-600 mt-1">
            <i class="fas fa-arrow-up mr-1"></i>
            <span x-text="stats.newUsersToday"></span> 今日の新規
          </div>
        </div>
        <div class="stats-card rounded-xl p-6 text-center">
          <div class="text-3xl font-bold text-green-600 mb-2" x-text="stats.activeUsers"></div>
          <div class="text-gray-600 text-sm">アクティブユーザー</div>
          <div class="text-xs text-blue-600 mt-1">
            <span x-text="Math.round(stats.activeUsers / stats.totalUsers * 100)"></span>% の利用率
          </div>
        </div>
        <div class="stats-card rounded-xl p-6 text-center">
          <div class="text-3xl font-bold text-purple-600 mb-2" x-text="stats.helpers"></div>
          <div class="text-gray-600 text-sm">登録ヘルパー</div>
          <div class="text-xs text-purple-600 mt-1">
            <span x-text="Math.round(stats.helpers / stats.totalUsers * 100)"></span>% がヘルパー
          </div>
        </div>
        <div class="stats-card rounded-xl p-6 text-center">
          <div class="text-3xl font-bold text-red-600 mb-2" x-text="stats.suspendedUsers"></div>
          <div class="text-gray-600 text-sm">停止中ユーザー</div>
          <div class="text-xs text-red-600 mt-1">
            要注意アカウント
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters and Search -->
  <div class="max-w-7xl mx-auto px-4 mb-8">
    <div class="glass-effect rounded-xl p-6">
      <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-4 lg:space-y-0">
        
        <!-- Search -->
        <div class="flex items-center space-x-4">
          <div class="relative">
            <input type="text" x-model="searchQuery" @input="filterUsers()" 
                   placeholder="名前、メール、IDで検索..." 
                   class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 w-80">
            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
          </div>
          <button @click="showAdvancedFilters = !showAdvancedFilters" 
                  class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
            <i class="fas fa-filter mr-2"></i>
            高度なフィルター
          </button>
        </div>

        <!-- Quick Filters -->
        <div class="flex flex-wrap gap-2">
          <template x-for="filter in quickFilters" :key="filter.key">
            <span @click="toggleFilter(filter.key)" 
                  :class="activeFilters.includes(filter.key) ? 'filter-tag active' : 'filter-tag'"
                  x-text="filter.label">
            </span>
          </template>
        </div>
      </div>

      <!-- Advanced Filters -->
      <div x-show="showAdvancedFilters" class="mt-6 pt-6 border-t border-gray-200">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">登録日</label>
            <select x-model="filters.registrationDate" @change="filterUsers()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
              <option value="">すべて</option>
              <option value="today">今日</option>
              <option value="week">過去1週間</option>
              <option value="month">過去1ヶ月</option>
              <option value="quarter">過去3ヶ月</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">最終ログイン</label>
            <select x-model="filters.lastLogin" @change="filterUsers()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
              <option value="">すべて</option>
              <option value="today">今日</option>
              <option value="week">過去1週間</option>
              <option value="month">過去1ヶ月</option>
              <option value="inactive">1ヶ月以上非アクティブ</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">評価</label>
            <select x-model="filters.rating" @change="filterUsers()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
              <option value="">すべて</option>
              <option value="5">5.0</option>
              <option value="4">4.0以上</option>
              <option value="3">3.0以上</option>
              <option value="low">3.0未満</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">完了タスク数</label>
            <select x-model="filters.taskCount" @change="filterUsers()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
              <option value="">すべて</option>
              <option value="none">0件</option>
              <option value="low">1-10件</option>
              <option value="medium">11-50件</option>
              <option value="high">51件以上</option>
            </select>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bulk Actions -->
  <div x-show="showBulkActions" class="max-w-7xl mx-auto px-4 mb-6">
    <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center">
          <input type="checkbox" @change="toggleSelectAll($event)" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
          <span class="ml-3 text-sm text-gray-700">
            <span x-text="selectedUsers.length"></span> 人を選択中
          </span>
        </div>
        <div class="flex items-center space-x-2">
          <button @click="bulkAction('activate')" class="px-3 py-1 bg-green-600 text-white text-sm rounded hover:bg-green-700 transition-colors">
            一括有効化
          </button>
          <button @click="bulkAction('suspend')" class="px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700 transition-colors">
            一括停止
          </button>
          <button @click="bulkAction('export')" class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 transition-colors">
            選択をエクスポート
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Users Table -->
  <div class="max-w-7xl mx-auto px-4 pb-8">
    <div class="glass-effect rounded-xl overflow-hidden">
      <div class="p-6 border-b border-gray-200">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-bold text-gray-900">ユーザー一覧</h2>
          <div class="flex items-center space-x-3">
            <span class="text-sm text-gray-500">
              <span x-text="filteredUsers.length"></span> 人中 
              <span x-text="Math.min(currentPage * usersPerPage, filteredUsers.length)"></span> 人を表示
            </span>
            <select x-model="sortBy" @change="sortUsers()" class="px-3 py-1 border border-gray-300 rounded text-sm focus:ring-blue-500 focus:border-blue-500">
              <option value="name">名前順</option>
              <option value="registration">登録日順</option>
              <option value="lastLogin">最終ログイン順</option>
              <option value="tasks">タスク数順</option>
              <option value="rating">評価順</option>
            </select>
          </div>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gray-50">
            <tr>
              <th x-show="showBulkActions" class="px-6 py-3 text-left">
                <input type="checkbox" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ユーザー</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ステータス</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">役割</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">実績</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">最終ログイン</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <template x-for="user in paginatedUsers" :key="user.id">
              <tr class="hover:bg-gray-50">
                <td x-show="showBulkActions" class="px-6 py-4">
                  <input type="checkbox" :value="user.id" @change="toggleUserSelection(user.id, $event)" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                </td>
                <td class="px-6 py-4">
                  <div class="flex items-center">
                    <img :src="user.avatar" :alt="user.name" class="w-10 h-10 rounded-full object-cover">
                    <div class="ml-4">
                      <div class="text-sm font-medium text-gray-900" x-text="user.name"></div>
                      <div class="text-sm text-gray-500" x-text="user.email"></div>
                      <div class="text-xs text-gray-400">ID: <span x-text="user.id"></span></div>
                    </div>
                  </div>
                </td>
                <td class="px-6 py-4">
                  <div class="flex flex-col space-y-1">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium" 
                          :class="`status-${user.status}`">
                      <i :class="{
                        'fas fa-check-circle': user.status === 'active',
                        'fas fa-ban': user.status === 'suspended',
                        'fas fa-clock': user.status === 'pending'
                      }" class="mr-1"></i>
                      <span x-text="getStatusText(user.status)"></span>
                    </span>
                    <span x-show="user.verified" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium status-verified">
                      <i class="fas fa-shield-check mr-1"></i>
                      認証済み
                    </span>
                  </div>
                </td>
                <td class="px-6 py-4">
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium" 
                        :class="`role-${user.role}`">
                    <i :class="{
                      'fas fa-crown': user.role === 'admin',
                      'fas fa-hands-helping': user.role === 'helper',
                      'fas fa-user': user.role === 'user'
                    }" class="mr-1"></i>
                    <span x-text="getRoleText(user.role)"></span>
                  </span>
                </td>
                <td class="px-6 py-4">
                  <div class="text-sm text-gray-900">
                    <div class="flex items-center mb-1">
                      <i class="fas fa-tasks text-blue-500 mr-2"></i>
                      <span x-text="user.completedTasks"></span> 件完了
                    </div>
                    <div x-show="user.role === 'helper'" class="flex items-center">
                      <div class="flex text-yellow-400 mr-2">
                        <template x-for="i in 5">
                          <i :class="i <= user.rating ? 'fas fa-star' : 'far fa-star'" class="text-xs"></i>
                        </template>
                      </div>
                      <span class="text-xs text-gray-500" x-text="user.rating"></span>
                    </div>
                  </div>
                </td>
                <td class="px-6 py-4 text-sm text-gray-500">
                  <div x-text="formatDate(user.lastLogin)"></div>
                  <div class="text-xs" x-text="getTimeAgo(user.lastLogin)"></div>
                </td>
                <td class="px-6 py-4">
                  <div class="flex items-center space-x-2">
                    <button @click="viewUserDetail(user)" class="action-button action-edit" title="詳細表示">
                      <i class="fas fa-eye"></i>
                    </button>
                    <button @click="editUser(user)" class="action-button action-edit" title="編集">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button x-show="user.status === 'active'" @click="suspendUser(user)" class="action-button action-suspend" title="停止">
                      <i class="fas fa-ban"></i>
                    </button>
                    <button x-show="user.status === 'suspended'" @click="activateUser(user)" class="action-button action-activate" title="有効化">
                      <i class="fas fa-check"></i>
                    </button>
                    <div class="relative" x-data="{ open: false }">
                      <button @click="open = !open" class="action-button text-gray-600 bg-gray-100 border-gray-200" title="その他">
                        <i class="fas fa-ellipsis-v"></i>
                      </button>
                      <div x-show="open" @click.away="open = false" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-10 border border-gray-200">
                        <div class="py-1">
                          <button @click="sendMessage(user); open = false" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                            <i class="fas fa-envelope mr-2"></i>メッセージ送信
                          </button>
                          <button @click="viewLoginHistory(user); open = false" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                            <i class="fas fa-history mr-2"></i>ログイン履歴
                          </button>
                          <button @click="resetPassword(user); open = false" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                            <i class="fas fa-key mr-2"></i>パスワードリセット
                          </button>
                          <hr class="my-1">
                          <button @click="deleteUser(user); open = false" class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50">
                            <i class="fas fa-trash mr-2"></i>アカウント削除
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="bg-white px-6 py-4 border-t border-gray-200">
        <div class="flex items-center justify-between">
          <div class="text-sm text-gray-700">
            <span x-text="(currentPage - 1) * usersPerPage + 1"></span> - 
            <span x-text="Math.min(currentPage * usersPerPage, filteredUsers.length)"></span> / 
            <span x-text="filteredUsers.length"></span> 件
          </div>
          <div class="flex items-center space-x-2">
            <button @click="currentPage > 1 && (currentPage--)" 
                    :disabled="currentPage === 1"
                    class="px-3 py-1 border border-gray-300 rounded disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-50">
              前へ
            </button>
            <template x-for="page in visiblePages" :key="page">
              <button @click="currentPage = page" 
                      :class="currentPage === page ? 'bg-blue-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-50'"
                      class="px-3 py-1 border border-gray-300 rounded"
                      x-text="page">
              </button>
            </template>
            <button @click="currentPage < totalPages && (currentPage++)" 
                    :disabled="currentPage === totalPages"
                    class="px-3 py-1 border border-gray-300 rounded disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-50">
              次へ
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- User Detail Modal -->
<div x-show="showUserModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" style="display: none;">
  <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto" @click.away="showUserModal = false">
    <div class="p-6">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-2xl font-bold text-gray-900">ユーザー詳細</h3>
        <button @click="showUserModal = false" class="text-gray-400 hover:text-gray-600">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      
      <div x-show="selectedUser" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- User Info -->
        <div class="lg:col-span-1">
          <div class="bg-gray-50 rounded-lg p-4 mb-4">
            <div class="text-center mb-4">
              <img :src="selectedUser?.avatar" :alt="selectedUser?.name" class="w-24 h-24 rounded-full object-cover mx-auto mb-3">
              <h4 class="text-xl font-bold" x-text="selectedUser?.name"></h4>
              <p class="text-gray-600" x-text="selectedUser?.email"></p>
            </div>
            
            <div class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span>ユーザーID:</span>
                <span x-text="selectedUser?.id"></span>
              </div>
              <div class="flex justify-between">
                <span>登録日:</span>
                <span x-text="formatDate(selectedUser?.registrationDate)"></span>
              </div>
              <div class="flex justify-between">
                <span>最終ログイン:</span>
                <span x-text="formatDate(selectedUser?.lastLogin)"></span>
              </div>
              <div class="flex justify-between">
                <span>完了タスク:</span>
                <span x-text="selectedUser?.completedTasks + ' 件'"></span>
              </div>
            </div>
          </div>
          
          <!-- Quick Actions -->
          <div class="space-y-2">
            <button @click="editUser(selectedUser)" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
              編集
            </button>
            <button x-show="selectedUser?.status === 'active'" @click="suspendUser(selectedUser)" class="w-full bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition-colors">
              アカウント停止
            </button>
            <button x-show="selectedUser?.status === 'suspended'" @click="activateUser(selectedUser)" class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">
              アカウント有効化
            </button>
          </div>
        </div>
        
        <!-- Activity Timeline -->
        <div class="lg:col-span-2">
          <h4 class="text-lg font-semibold mb-4">最近のアクティビティ</h4>
          <div class="activity-timeline">
            <template x-for="activity in selectedUser?.activities || []" :key="activity.id">
              <div class="activity-item">
                <div class="activity-dot" :class="activity.type"></div>
                <div class="bg-white border border-gray-200 rounded-lg p-3">
                  <div class="flex items-center justify-between mb-1">
                    <span class="font-medium text-gray-900" x-text="activity.title"></span>
                    <span class="text-xs text-gray-500" x-text="formatDate(activity.date)"></span>
                  </div>
                  <p class="text-sm text-gray-600" x-text="activity.description"></p>
                </div>
              </div>
            </template>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.10.1/sweetalert2.all.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Mobile menu functionality
  const mobileMenuButton = document.getElementById('mobile-menu-button');
  const mobileMenu = document.getElementById('mobile-menu');
  const menuIcon = document.getElementById('menu-icon');
  const closeIcon = document.getElementById('close-icon');
  
  if (mobileMenuButton && mobileMenu) {
    mobileMenuButton.addEventListener('click', function() {
      const isExpanded = this.getAttribute('aria-expanded') === 'true';
      this.setAttribute('aria-expanded', !isExpanded);
      mobileMenu.classList.toggle('hidden');
      
      // Toggle menu/close icons
      if (menuIcon && closeIcon) {
        menuIcon.classList.toggle('opacity-0');
        closeIcon.classList.toggle('opacity-0');
      }
    });
    
    // Close menu when clicking links
    mobileMenu.addEventListener('click', function(event) {
      if (event.target.tagName === 'A') {
        mobileMenu.classList.add('hidden');
        mobileMenuButton.setAttribute('aria-expanded', 'false');
        if (menuIcon && closeIcon) {
          menuIcon.classList.remove('opacity-0');
          closeIcon.classList.add('opacity-0');
        }
      }
    });
  }
});

// Admin Users App using Alpine.js
function adminUsersApp() {
  return {
    // Data
    searchQuery: '',
    showAdvancedFilters: false,
    showBulkActions: false,
    showUserModal: false,
    selectedUser: null,
    selectedUsers: [],
    currentPage: 1,
    usersPerPage: 10,
    sortBy: 'name',
    
    // Filters
    activeFilters: [],
    filters: {
      registrationDate: '',
      lastLogin: '',
      rating: '',
      taskCount: ''
    },
    
    quickFilters: [
      { key: 'active', label: 'アクティブ' },
      { key: 'helpers', label: 'ヘルパー' },
      { key: 'verified', label: '認証済み' },
      { key: 'suspended', label: '停止中' },
      { key: 'new', label: '新規' }
    ],
    
    // Mock data
    allUsers: [],
    filteredUsers: [],
    
    stats: {
      totalUsers: 1247,
      activeUsers: 892,
      helpers: 324,
      suspendedUsers: 23,
      newUsersToday: 12
    },
    
    init() {
      this.generateMockUsers();
      this.filterUsers();
    },
    
    generateMockUsers() {
      const names = [
        '田中太郎', '佐藤花子', '山田一郎', '鈴木美咲', '高橋健一',
        '渡辺由美', '伊藤大輔', '中村恵子', '小林直人', '加藤裕子',
        '吉田雅人', '山本智子', '松本和也', '井上真理', '木村秀樹',
        '林美香', '清水健太', '森田優子', '池田博', '橋本さくら'
      ];
      
      const statuses = ['active', 'suspended', 'pending'];
      const roles = ['user', 'helper', 'admin'];
      
      this.allUsers = names.map((name, index) => {
        const registrationDate = new Date(Date.now() - Math.random() * 365 * 24 * 60 * 60 * 1000);
        const lastLogin = new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000);
        const role = roles[Math.floor(Math.random() * roles.length)];
        
        return {
          id: 1000 + index,
          name: name,
          email: `${name.toLowerCase().replace(/\s/g, '')}@example.com`,
          avatar: `https://images.unsplash.com/photo-${1500000000000 + Math.random() * 100000000}?w=40&h=40&fit=crop&crop=face`,
          status: statuses[Math.floor(Math.random() * statuses.length)],
          role: role,
          verified: Math.random() > 0.3,
          registrationDate: registrationDate.toISOString(),
          lastLogin: lastLogin.toISOString(),
          completedTasks: Math.floor(Math.random() * 100),
          rating: role === 'helper' ? Math.round((4 + Math.random()) * 10) / 10 : null,
          activities: this.generateUserActivities()
        };
      });
    },
    
    generateUserActivities() {
      const activities = [
        { type: 'login', title: 'ログイン', description: 'システムにログインしました' },
        { type: 'task', title: 'タスク完了', description: '掃除タスクを完了しました' },
        { type: 'payment', title: '決済完了', description: '3,000円の支払いを受け取りました' },
        { type: 'review', title: 'レビュー投稿', description: '5つ星のレビューを受け取りました' }
      ];
      
      return activities.slice(0, Math.floor(Math.random() * 4) + 1).map((activity, index) => ({
        id: index,
        ...activity,
        date: new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000).toISOString()
      }));
    },
    
    // Filtering and sorting
    filterUsers() {
      let filtered = [...this.allUsers];
      
      // Text search
      if (this.searchQuery) {
        const query = this.searchQuery.toLowerCase();
        filtered = filtered.filter(user => 
          user.name.toLowerCase().includes(query) ||
          user.email.toLowerCase().includes(query) ||
          user.id.toString().includes(query)
        );
      }
      
      // Quick filters
      this.activeFilters.forEach(filter => {
        switch (filter) {
          case 'active':
            filtered = filtered.filter(user => user.status === 'active');
            break;
          case 'helpers':
            filtered = filtered.filter(user => user.role === 'helper');
            break;
          case 'verified':
            filtered = filtered.filter(user => user.verified);
            break;
          case 'suspended':
            filtered = filtered.filter(user => user.status === 'suspended');
            break;
          case 'new':
            const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
            filtered = filtered.filter(user => new Date(user.registrationDate) > weekAgo);
            break;
        }
      });
      
      // Advanced filters
      if (this.filters.registrationDate) {
        // Implementation for registration date filter
      }
      
      if (this.filters.lastLogin) {
        // Implementation for last login filter
      }
      
      this.filteredUsers = filtered;
      this.sortUsers();
    },
    
    sortUsers() {
      this.filteredUsers.sort((a, b) => {
        switch (this.sortBy) {
          case 'name':
            return a.name.localeCompare(b.name);
          case 'registration':
            return new Date(b.registrationDate) - new Date(a.registrationDate);
          case 'lastLogin':
            return new Date(b.lastLogin) - new Date(a.lastLogin);
          case 'tasks':
            return b.completedTasks - a.completedTasks;
          case 'rating':
            return (b.rating || 0) - (a.rating || 0);
          default:
            return 0;
        }
      });
      this.currentPage = 1;
    },
    
    toggleFilter(filterKey) {
      const index = this.activeFilters.indexOf(filterKey);
      if (index > -1) {
        this.activeFilters.splice(index, 1);
      } else {
        this.activeFilters.push(filterKey);
      }
      this.filterUsers();
    },
    
    // Pagination
    get totalPages() {
      return Math.ceil(this.filteredUsers.length / this.usersPerPage);
    },
    
    get paginatedUsers() {
      const start = (this.currentPage - 1) * this.usersPerPage;
      return this.filteredUsers.slice(start, start + this.usersPerPage);
    },
    
    get visiblePages() {
      const pages = [];
      const start = Math.max(1, this.currentPage - 2);
      const end = Math.min(this.totalPages, this.currentPage + 2);
      
      for (let i = start; i <= end; i++) {
        pages.push(i);
      }
      
      return pages;
    },
    
    // User actions
    viewUserDetail(user) {
      this.selectedUser = user;
      this.showUserModal = true;
    },
    
    editUser(user) {
      Swal.fire({
        title: 'ユーザー編集',
        html: `
          <div class="text-left space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">名前</label>
              <input id="edit-name" type="text" value="${user.name}" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">メールアドレス</label>
              <input id="edit-email" type="email" value="${user.email}" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">役割</label>
              <select id="edit-role" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                <option value="user" ${user.role === 'user' ? 'selected' : ''}>一般ユーザー</option>
                <option value="helper" ${user.role === 'helper' ? 'selected' : ''}>ヘルパー</option>
                <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>管理者</option>
              </select>
            </div>
          </div>
        `,
        showCancelButton: true,
        confirmButtonText: '保存',
        cancelButtonText: 'キャンセル',
        confirmButtonColor: '#3b82f6',
        preConfirm: () => {
          const name = document.getElementById('edit-name').value;
          const email = document.getElementById('edit-email').value;
          const role = document.getElementById('edit-role').value;
          
          if (!name.trim() || !email.trim()) {
            Swal.showValidationMessage('名前とメールアドレスを入力してください');
            return false;
          }
          
          return { name, email, role };
        }
      }).then((result) => {
        if (result.isConfirmed) {
          user.name = result.value.name;
          user.email = result.value.email;
          user.role = result.value.role;
          toastr.success('ユーザー情報を更新しました');
        }
      });
    },
    
    suspendUser(user) {
      Swal.fire({
        title: 'アカウント停止',
        text: `${user.name}のアカウントを停止しますか？`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: '停止',
        cancelButtonText: 'キャンセル',
        confirmButtonColor: '#dc2626'
      }).then((result) => {
        if (result.isConfirmed) {
          user.status = 'suspended';
          toastr.success('アカウントを停止しました');
        }
      });
    },
    
    activateUser(user) {
      user.status = 'active';
      toastr.success('アカウントを有効化しました');
    },
    
    deleteUser(user) {
      Swal.fire({
        title: 'アカウント削除',
        text: `${user.name}のアカウントを削除しますか？この操作は取り消せません。`,
        icon: 'error',
        showCancelButton: true,
        confirmButtonText: '削除',
        cancelButtonText: 'キャンセル',
        confirmButtonColor: '#dc2626'
      }).then((result) => {
        if (result.isConfirmed) {
          const index = this.allUsers.findIndex(u => u.id === user.id);
          if (index > -1) {
            this.allUsers.splice(index, 1);
            this.filterUsers();
            toastr.success('アカウントを削除しました');
          }
        }
      });
    },
    
    // Bulk actions
    toggleSelectAll(event) {
      if (event.target.checked) {
        this.selectedUsers = this.paginatedUsers.map(user => user.id);
      } else {
        this.selectedUsers = [];
      }
    },
    
    toggleUserSelection(userId, event) {
      if (event.target.checked) {
        this.selectedUsers.push(userId);
      } else {
        const index = this.selectedUsers.indexOf(userId);
        if (index > -1) {
          this.selectedUsers.splice(index, 1);
        }
      }
    },
    
    bulkAction(action) {
      if (this.selectedUsers.length === 0) {
        toastr.warning('ユーザーを選択してください');
        return;
      }
      
      switch (action) {
        case 'activate':
          this.selectedUsers.forEach(id => {
            const user = this.allUsers.find(u => u.id === id);
            if (user) user.status = 'active';
          });
          toastr.success(`${this.selectedUsers.length}人のアカウントを有効化しました`);
          break;
        case 'suspend':
          this.selectedUsers.forEach(id => {
            const user = this.allUsers.find(u => u.id === id);
            if (user) user.status = 'suspended';
          });
          toastr.success(`${this.selectedUsers.length}人のアカウントを停止しました`);
          break;
        case 'export':
          this.exportSelectedUsers();
          break;
      }
      
      this.selectedUsers = [];
    },
    
    // Export functionality
    exportUsers() {
      const csv = this.generateCSV(this.filteredUsers);
      this.downloadCSV(csv, 'users.csv');
      toastr.success('ユーザーデータをエクスポートしました');
    },
    
    exportSelectedUsers() {
      const selectedUserData = this.allUsers.filter(user => this.selectedUsers.includes(user.id));
      const csv = this.generateCSV(selectedUserData);
      this.downloadCSV(csv, 'selected_users.csv');
      toastr.success('選択されたユーザーデータをエクスポートしました');
    },
    
    generateCSV(users) {
      const headers = ['ID', '名前', 'メールアドレス', 'ステータス', '役割', '登録日', '最終ログイン', '完了タスク数', '評価'];
      const rows = users.map(user => [
        user.id,
        user.name,
        user.email,
        this.getStatusText(user.status),
        this.getRoleText(user.role),
        this.formatDate(user.registrationDate),
        this.formatDate(user.lastLogin),
        user.completedTasks,
        user.rating || 'N/A'
      ]);
      
      return [headers, ...rows]
        .map(row => row.map(field => `"${field}"`).join(','))
        .join('\n');
    },
    
    downloadCSV(csv, filename) {
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', filename);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    },
    
    // Utility functions
    getStatusText(status) {
      const statusMap = {
        'active': 'アクティブ',
        'suspended': '停止中',
        'pending': '承認待ち'
      };
      return statusMap[status] || status;
    },
    
    getRoleText(role) {
      const roleMap = {
        'admin': '管理者',
        'helper': 'ヘルパー',
        'user': '一般ユーザー'
      };
      return roleMap[role] || role;
    },
    
    formatDate(dateString) {
      return new Date(dateString).toLocaleDateString('ja-JP');
    },
    
    getTimeAgo(dateString) {
      const now = new Date();
      const date = new Date(dateString);
      const diffInMinutes = Math.floor((now - date) / (1000 * 60));
      
      if (diffInMinutes < 60) return `${diffInMinutes}分前`;
      if (diffInMinutes < 1440) return `${Math.floor(diffInMinutes / 60)}時間前`;
      return `${Math.floor(diffInMinutes / 1440)}日前`;
    },
    
    // Other actions
    sendMessage(user) {
      toastr.info(`${user.name}にメッセージを送信しました`);
    },
    
    viewLoginHistory(user) {
      toastr.info(`${user.name}のログイン履歴を表示しています`);
    },
    
    resetPassword(user) {
      Swal.fire({
        title: 'パスワードリセット',
        text: `${user.name}にパスワードリセットメールを送信しますか？`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: '送信',
        cancelButtonText: 'キャンセル'
      }).then((result) => {
        if (result.isConfirmed) {
          toastr.success('パスワードリセットメールを送信しました');
        }
      });
    }
  }
}

// Configure Toastr
toastr.options = {
  "closeButton": true,
  "progressBar": true,
  "positionClass": "toast-top-right",
  "timeOut": "4000"
};
</script>

</body>
</html>