<!DOCTYPE html>
<html lang="ja" class="scroll-smooth">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>詳細分析ダッシュボード - 管理者ダッシュボード | TaskHelper</title>
  
  <!-- CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- CSS Libraries -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  
  <!-- Additional UI Libraries -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.10.1/sweetalert2.min.css" rel="stylesheet">
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- Alpine.js -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  
  <!-- Custom CSS -->
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', sans-serif;
    }
    
    .glass-effect {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .admin-header {
      background: linear-gradient(135deg, #7c3aed 0%, #8b5cf6 50%, #a855f7 100%);
      border-bottom: 3px solid #6d28d9;
    }
    
    .chart-container {
      background: white;
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      border: 1px solid #f1f5f9;
      transition: all 0.2s ease;
    }
    
    .chart-container:hover {
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
      transform: translateY(-2px);
    }
    
    .metric-card {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(248, 250, 252, 0.9));
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      border-radius: 1rem;
      padding: 1.5rem;
      text-align: center;
      transition: all 0.3s ease;
    }
    
    .metric-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    }
    
    .metric-value {
      font-size: 2.5rem;
      font-weight: bold;
      line-height: 1;
      margin-bottom: 0.5rem;
    }
    
    .metric-label {
      color: #6b7280;
      font-size: 0.875rem;
      font-weight: 500;
    }
    
    .metric-change {
      font-size: 0.75rem;
      font-weight: 600;
      margin-top: 0.5rem;
    }
    
    .metric-change.positive {
      color: #059669;
    }
    
    .metric-change.negative {
      color: #dc2626;
    }
    
    .metric-change.neutral {
      color: #6b7280;
    }
    
    .filter-tabs {
      display: flex;
      background: #f8fafc;
      border-radius: 0.75rem;
      padding: 0.25rem;
      margin-bottom: 1.5rem;
    }
    
    .filter-tab {
      flex: 1;
      padding: 0.75rem 1rem;
      text-align: center;
      border-radius: 0.5rem;
      font-weight: 500;
      transition: all 0.2s ease;
      cursor: pointer;
    }
    
    .filter-tab.active {
      background: white;
      color: #7c3aed;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .filter-tab:not(.active) {
      color: #6b7280;
    }
    
    .filter-tab:not(.active):hover {
      background: rgba(255, 255, 255, 0.5);
      color: #374151;
    }
    
    .data-table {
      background: white;
      border-radius: 1rem;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      border: 1px solid #f1f5f9;
    }
    
    .table-header {
      background: #f8fafc;
      padding: 1rem 1.5rem;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .trend-indicator {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    .trend-up {
      background: #dcfce7;
      color: #166534;
    }
    
    .trend-down {
      background: #fef2f2;
      color: #dc2626;
    }
    
    .trend-stable {
      background: #f3f4f6;
      color: #374151;
    }
    
    .export-button {
      background: linear-gradient(135deg, #7c3aed, #8b5cf6);
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      font-weight: 600;
      transition: all 0.2s ease;
      border: none;
      cursor: pointer;
    }
    
    .export-button:hover {
      background: linear-gradient(135deg, #6d28d9, #7c3aed);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
    }
    
    .insight-card {
      background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
      border: 1px solid #bae6fd;
      border-radius: 1rem;
      padding: 1.5rem;
      margin-bottom: 1rem;
    }
    
    .insight-icon {
      width: 3rem;
      height: 3rem;
      background: #3b82f6;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      margin-bottom: 1rem;
    }
    
    .heatmap-cell {
      border-radius: 0.25rem;
      transition: all 0.2s ease;
      cursor: pointer;
    }
    
    .heatmap-cell:hover {
      transform: scale(1.1);
      z-index: 10;
    }
    
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #7c3aed;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>

<body class="bg-gradient-to-br from-purple-50 via-white to-blue-50 min-h-screen">

<!-- Navigation -->
<nav class="bg-white shadow-sm fixed top-0 left-0 right-0 z-50">
  <div class="max-w-7xl mx-auto px-4">
    <div class="flex items-center h-16">
      <!-- Logo -->
      <div class="flex items-center space-x-2">
        <i class="fas fa-hands-helping text-2xl text-blue-600" aria-hidden="true"></i>
        <span class="text-xl font-bold text-gray-900">TaskHelper</span>
        <span class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded-full font-medium">ADMIN</span>
      </div>
      
      <!-- Desktop Menu (centered) -->
      <div class="hidden md:flex items-center space-x-8 mx-auto">
        <a href="dashboard.html" class="text-gray-700 hover:text-blue-600 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2 focus:rounded px-2 py-1 no-underline">ダッシュボード</a>
        <a href="users.html" class="text-gray-700 hover:text-blue-600 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2 focus:rounded px-2 py-1 no-underline">ユーザー管理</a>
        <a href="disputes.html" class="text-gray-700 hover:text-blue-600 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2 focus:rounded px-2 py-1 no-underline">分争解決</a>
        <a href="analytics.html" class="text-purple-600 font-medium focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2 focus:rounded px-2 py-1 no-underline">分析</a>
        <a href="content.html" class="text-gray-700 hover:text-blue-600 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2 focus:rounded px-2 py-1 no-underline">コンテンツ</a>
      </div>
      
      <!-- Admin Actions -->
      <div class="hidden md:flex items-center space-x-3">
        <button class="text-gray-600 hover:text-gray-800 p-2 rounded-lg hover:bg-gray-100 transition-colors">
          <i class="fas fa-bell"></i>
        </button>
        <a href="index.html" class="border border-blue-600 text-blue-600 px-4 py-2 rounded-lg font-semibold hover:bg-blue-50 transition-colors">サイトに戻る</a>
      </div>
      
      <!-- Mobile Menu Button -->
      <div class="md:hidden ml-auto">
        <button id="mobile-menu-button" class="text-gray-700 hover:text-blue-600 p-2 transition-all duration-300 ease-in-out" aria-expanded="false">
          <svg class="w-6 h-6 transition-transform duration-300 ease-in-out" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path id="menu-icon" class="transition-opacity duration-300" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
            <path id="close-icon" class="transition-opacity duration-300 opacity-0" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
    </div>
    
    <!-- Mobile Menu -->
    <div id="mobile-menu" class="hidden md:hidden pb-4 transition-all duration-300 ease-in-out transform">
      <div class="flex flex-col space-y-2">
        <a href="dashboard.html" class="block px-3 py-2 text-gray-700 hover:text-blue-600 hover:bg-gray-50 rounded">ダッシュボード</a>
        <a href="users.html" class="block px-3 py-2 text-gray-700 hover:text-blue-600 hover:bg-gray-50 rounded">ユーザー管理</a>
        <a href="disputes.html" class="block px-3 py-2 text-gray-700 hover:text-blue-600 hover:bg-gray-50 rounded">分争解決</a>
        <a href="analytics.html" class="block px-3 py-2 text-purple-600 bg-purple-50 rounded font-medium">分析</a>
        <a href="content.html" class="block px-3 py-2 text-gray-700 hover:text-blue-600 hover:bg-gray-50 rounded">コンテンツ</a>
        <hr class="my-3">
        <a href="index.html" class="block px-3 py-2 text-blue-600 hover:bg-blue-50 rounded">サイトに戻る</a>
      </div>
    </div>
  </div>
</nav>

<!-- Main Content -->
<main class="min-h-screen pt-16" x-data="adminAnalyticsApp()">
  
  <!-- Header -->
  <div class="admin-header text-white py-8">
    <div class="max-w-7xl mx-auto px-4">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-3xl font-bold mb-2">詳細分析ダッシュボード</h1>
          <p class="text-purple-100">プラットフォームの詳細なデータ分析と洞察</p>
        </div>
        <div class="flex items-center space-x-3">
          <button @click="refreshData()" class="bg-white bg-opacity-20 text-white px-4 py-2 rounded-lg hover:bg-opacity-30 transition-colors">
            <i class="fas fa-sync-alt mr-2" :class="loading ? 'fa-spin' : ''"></i>
            <span x-show="!loading">データ更新</span>
            <span x-show="loading">更新中...</span>
          </button>
          <button @click="scheduleReport()" class="bg-purple-800 text-white px-4 py-2 rounded-lg hover:bg-purple-900 transition-colors">
            <i class="fas fa-calendar mr-2"></i>
            定期レポート設定
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Time Filter -->
  <div class="max-w-7xl mx-auto px-4 py-6">
    <div class="filter-tabs">
      <template x-for="period in timePeriods" :key="period.key">
        <div @click="selectedPeriod = period.key; loadAnalytics()" 
             :class="selectedPeriod === period.key ? 'filter-tab active' : 'filter-tab'"
             x-text="period.label">
        </div>
      </template>
    </div>
  </div>

  <!-- Key Metrics -->
  <div class="max-w-7xl mx-auto px-4 mb-8">
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
      <div class="metric-card">
        <div class="metric-value text-blue-600" x-text="metrics.revenue.toLocaleString() + '円'"></div>
        <div class="metric-label">総収益</div>
        <div class="metric-change positive">
          <i class="fas fa-arrow-up mr-1"></i>
          <span x-text="metrics.revenueChange + '%'"></span> 前期比
        </div>
      </div>
      
      <div class="metric-card">
        <div class="metric-value text-green-600" x-text="metrics.activeUsers.toLocaleString()"></div>
        <div class="metric-label">アクティブユーザー</div>
        <div class="metric-change positive">
          <i class="fas fa-arrow-up mr-1"></i>
          <span x-text="metrics.activeUsersChange + '%'"></span> 前期比
        </div>
      </div>
      
      <div class="metric-card">
        <div class="metric-value text-purple-600" x-text="metrics.tasksCompleted.toLocaleString()"></div>
        <div class="metric-label">完了タスク数</div>
        <div class="metric-change positive">
          <i class="fas fa-arrow-up mr-1"></i>
          <span x-text="metrics.tasksChange + '%'"></span> 前期比
        </div>
      </div>
      
      <div class="metric-card">
        <div class="metric-value text-orange-600" x-text="metrics.avgRating"></div>
        <div class="metric-label">平均評価</div>
        <div class="metric-change neutral">
          <i class="fas fa-minus mr-1"></i>
          変化なし
        </div>
      </div>
    </div>
  </div>

  <!-- Charts Section -->
  <div class="max-w-7xl mx-auto px-4 mb-8">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      
      <!-- Revenue Trend -->
      <div class="chart-container">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-bold text-gray-900">収益推移</h3>
          <button @click="exportChart('revenue')" class="text-sm text-purple-600 hover:text-purple-700">
            <i class="fas fa-download mr-1"></i>エクスポート
          </button>
        </div>
        <div class="h-80">
          <canvas id="revenueChart"></canvas>
        </div>
      </div>
      
      <!-- User Growth -->
      <div class="chart-container">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-bold text-gray-900">ユーザー成長</h3>
          <button @click="exportChart('users')" class="text-sm text-purple-600 hover:text-purple-700">
            <i class="fas fa-download mr-1"></i>エクスポート
          </button>
        </div>
        <div class="h-80">
          <canvas id="userGrowthChart"></canvas>
        </div>
      </div>
      
      <!-- Task Categories -->
      <div class="chart-container">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-bold text-gray-900">タスクカテゴリ別分析</h3>
          <button @click="exportChart('categories')" class="text-sm text-purple-600 hover:text-purple-700">
            <i class="fas fa-download mr-1"></i>エクスポート
          </button>
        </div>
        <div class="h-80">
          <canvas id="categoryChart"></canvas>
        </div>
      </div>
      
      <!-- Geographic Distribution -->
      <div class="chart-container">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-bold text-gray-900">地域別利用状況</h3>
          <button @click="exportChart('geographic')" class="text-sm text-purple-600 hover:text-purple-700">
            <i class="fas fa-download mr-1"></i>エクスポート
          </button>
        </div>
        <div class="h-80">
          <canvas id="geographicChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- User Behavior Analysis -->
  <div class="max-w-7xl mx-auto px-4 mb-8">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      
      <!-- Activity Heatmap -->
      <div class="lg:col-span-2 chart-container">
        <h3 class="text-xl font-bold text-gray-900 mb-4">利用時間ヒートマップ</h3>
        <div class="grid grid-cols-24 gap-1">
          <template x-for="hour in 24" :key="hour">
            <div class="text-xs text-center p-1" x-text="hour + '時'"></div>
          </template>
          <template x-for="day in ['月', '火', '水', '木', '金', '土', '日']" :key="day">
            <template>
              <div class="text-xs font-medium p-2 flex items-center" x-text="day"></div>
              <template x-for="hour in 23" :key="`${day}-${hour}`">
                <div class="heatmap-cell h-6 w-full" 
                     :style="`background-color: rgba(124, 58, 237, ${Math.random() * 0.8 + 0.1})`"
                     :title="`${day}曜日 ${hour}時: ${Math.floor(Math.random() * 100)}件のタスク`">
                </div>
              </template>
            </template>
          </template>
        </div>
      </div>
      
      <!-- AI Insights -->
      <div class="space-y-4">
        <div class="insight-card">
          <div class="insight-icon">
            <i class="fas fa-lightbulb"></i>
          </div>
          <h4 class="font-bold text-gray-900 mb-2">AI洞察</h4>
          <p class="text-sm text-gray-700 mb-3">
            金曜日の夕方から土曜日の朝にかけてタスク完了率が20%向上しています。
          </p>
          <button class="text-sm text-blue-600 hover:text-blue-700 font-medium">
            詳細分析 <i class="fas fa-arrow-right ml-1"></i>
          </button>
        </div>
        
        <div class="insight-card">
          <div class="insight-icon">
            <i class="fas fa-chart-line"></i>
          </div>
          <h4 class="font-bold text-gray-900 mb-2">トレンド予測</h4>
          <p class="text-sm text-gray-700 mb-3">
            掃除カテゴリの需要が来月15%増加する見込みです。
          </p>
          <button class="text-sm text-blue-600 hover:text-blue-700 font-medium">
            予測データ <i class="fas fa-arrow-right ml-1"></i>
          </button>
        </div>
        
        <div class="insight-card">
          <div class="insight-icon">
            <i class="fas fa-exclamation-triangle"></i>
          </div>
          <h4 class="font-bold text-gray-900 mb-2">注意事項</h4>
          <p class="text-sm text-gray-700 mb-3">
            新規ユーザーの7日間継続率が平均を下回っています。
          </p>
          <button class="text-sm text-red-600 hover:text-red-700 font-medium">
            改善案 <i class="fas fa-arrow-right ml-1"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Performance Metrics -->
  <div class="max-w-7xl mx-auto px-4 mb-8">
    <div class="data-table">
      <div class="table-header">
        <div class="flex items-center justify-between">
          <h3 class="text-xl font-bold text-gray-900">パフォーマンス指標</h3>
          <button @click="exportTable()" class="export-button">
            <i class="fas fa-file-excel mr-2"></i>
            全データ出力
          </button>
        </div>
      </div>
      
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">指標</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">現在値</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">前期比</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">目標値</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">達成率</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">トレンド</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <template x-for="metric in performanceMetrics" :key="metric.name">
              <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="flex items-center">
                    <i :class="metric.icon" class="text-gray-500 mr-3"></i>
                    <span class="text-sm font-medium text-gray-900" x-text="metric.name"></span>
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <span class="text-sm text-gray-900" x-text="metric.current"></span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <span class="text-sm" :class="metric.change >= 0 ? 'text-green-600' : 'text-red-600'">
                    <i :class="metric.change >= 0 ? 'fas fa-arrow-up' : 'fas fa-arrow-down'" class="mr-1"></i>
                    <span x-text="Math.abs(metric.change) + '%'"></span>
                  </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <span class="text-sm text-gray-500" x-text="metric.target"></span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="flex items-center">
                    <div class="w-16 bg-gray-200 rounded-full h-2 mr-2">
                      <div class="h-2 rounded-full" 
                           :class="metric.achievement >= 90 ? 'bg-green-500' : (metric.achievement >= 70 ? 'bg-yellow-500' : 'bg-red-500')"
                           :style="`width: ${Math.min(metric.achievement, 100)}%`"></div>
                    </div>
                    <span class="text-sm text-gray-900" x-text="metric.achievement + '%'"></span>
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <span class="trend-indicator" :class="metric.trend === 'up' ? 'trend-up' : (metric.trend === 'down' ? 'trend-down' : 'trend-stable')">
                    <i :class="metric.trend === 'up' ? 'fas fa-trending-up' : (metric.trend === 'down' ? 'fas fa-trending-down' : 'fas fa-minus')" class="mr-1"></i>
                    <span x-text="metric.trend === 'up' ? '上昇' : (metric.trend === 'down' ? '下降' : '安定')"></span>
                  </span>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Real-time Updates -->
  <div class="max-w-7xl mx-auto px-4 pb-8">
    <div class="chart-container">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold text-gray-900">リアルタイム更新</h3>
        <div class="flex items-center space-x-3">
          <div class="flex items-center text-sm text-gray-600">
            <div class="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"></div>
            <span x-text="'最終更新: ' + lastUpdated"></span>
          </div>
          <button @click="toggleAutoUpdate()" 
                  :class="autoUpdate ? 'bg-green-600 text-white' : 'bg-gray-200 text-gray-700'"
                  class="px-3 py-1 rounded-full text-sm font-medium transition-colors">
            <i class="fas fa-sync-alt mr-1"></i>
            <span x-text="autoUpdate ? '自動更新ON' : '自動更新OFF'"></span>
          </button>
        </div>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="text-center">
          <div class="text-3xl font-bold text-blue-600 mb-2" x-text="realTimeStats.currentUsers"></div>
          <div class="text-sm text-gray-600">現在のアクティブユーザー</div>
        </div>
        <div class="text-center">
          <div class="text-3xl font-bold text-green-600 mb-2" x-text="realTimeStats.tasksInProgress"></div>
          <div class="text-sm text-gray-600">進行中のタスク</div>
        </div>
        <div class="text-center">
          <div class="text-3xl font-bold text-purple-600 mb-2" x-text="realTimeStats.todayRevenue.toLocaleString() + '円'"></div>
          <div class="text-sm text-gray-600">本日の収益</div>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- JavaScript Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.10.1/sweetalert2.all.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Mobile menu functionality
  const mobileMenuButton = document.getElementById('mobile-menu-button');
  const mobileMenu = document.getElementById('mobile-menu');
  const menuIcon = document.getElementById('menu-icon');
  const closeIcon = document.getElementById('close-icon');
  
  if (mobileMenuButton && mobileMenu) {
    mobileMenuButton.addEventListener('click', function() {
      const isExpanded = this.getAttribute('aria-expanded') === 'true';
      this.setAttribute('aria-expanded', !isExpanded);
      mobileMenu.classList.toggle('hidden');
      
      // Toggle menu/close icons
      if (menuIcon && closeIcon) {
        menuIcon.classList.toggle('opacity-0');
        closeIcon.classList.toggle('opacity-0');
      }
    });
    
    // Close menu when clicking links
    mobileMenu.addEventListener('click', function(event) {
      if (event.target.tagName === 'A') {
        mobileMenu.classList.add('hidden');
        mobileMenuButton.setAttribute('aria-expanded', 'false');
        if (menuIcon && closeIcon) {
          menuIcon.classList.remove('opacity-0');
          closeIcon.classList.add('opacity-0');
        }
      }
    });
  }
});

// Admin Analytics App using Alpine.js
function adminAnalyticsApp() {
  return {
    // Data
    selectedPeriod: 'weekly',
    loading: false,
    autoUpdate: true,
    lastUpdated: new Date().toLocaleTimeString('ja-JP'),
    
    timePeriods: [
      { key: 'daily', label: '日別' },
      { key: 'weekly', label: '週別' },
      { key: 'monthly', label: '月別' },
      { key: 'yearly', label: '年別' }
    ],
    
    metrics: {
      revenue: 2450000,
      revenueChange: 12.5,
      activeUsers: 1247,
      activeUsersChange: 8.3,
      tasksCompleted: 3456,
      tasksChange: 15.7,
      avgRating: 4.8
    },
    
    performanceMetrics: [
      {
        name: 'ユーザー獲得率',
        icon: 'fas fa-user-plus',
        current: '245人/日',
        change: 12.5,
        target: '300人/日',
        achievement: 82,
        trend: 'up'
      },
      {
        name: 'タスク完了率',
        icon: 'fas fa-check-circle',
        current: '94.2%',
        change: 2.1,
        target: '95%',
        achievement: 99,
        trend: 'up'
      },
      {
        name: '平均応答時間',
        icon: 'fas fa-clock',
        current: '2.3時間',
        change: -8.5,
        target: '2時間',
        achievement: 87,
        trend: 'down'
      },
      {
        name: 'ユーザー満足度',
        icon: 'fas fa-star',
        current: '4.8/5.0',
        change: 0.2,
        target: '4.9/5.0',
        achievement: 98,
        trend: 'stable'
      },
      {
        name: '継続率（7日）',
        icon: 'fas fa-sync-alt',
        current: '68%',
        change: -5.2,
        target: '75%',
        achievement: 91,
        trend: 'down'
      }
    ],
    
    realTimeStats: {
      currentUsers: 89,
      tasksInProgress: 156,
      todayRevenue: 127000
    },
    
    // Charts
    revenueChart: null,
    userGrowthChart: null,
    categoryChart: null,
    geographicChart: null,
    
    init() {
      this.loadAnalytics();
      this.initializeCharts();
      this.startRealTimeUpdates();
    },
    
    async loadAnalytics() {
      this.loading = true;
      
      // Simulate API call
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      // Update charts with new data
      this.updateCharts();
      
      this.loading = false;
      this.lastUpdated = new Date().toLocaleTimeString('ja-JP');
      toastr.success('データを更新しました');
    },
    
    initializeCharts() {
      // Revenue Chart
      const revenueCtx = document.getElementById('revenueChart');
      this.revenueChart = new Chart(revenueCtx, {
        type: 'line',
        data: {
          labels: ['1月', '2月', '3月', '4月', '5月', '6月'],
          datasets: [{
            label: '収益',
            data: [1800000, 2100000, 1950000, 2300000, 2150000, 2450000],
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return value.toLocaleString() + '円';
                }
              }
            }
          }
        }
      });
      
      // User Growth Chart
      const userCtx = document.getElementById('userGrowthChart');
      this.userGrowthChart = new Chart(userCtx, {
        type: 'bar',
        data: {
          labels: ['1月', '2月', '3月', '4月', '5月', '6月'],
          datasets: [{
            label: '新規ユーザー',
            data: [156, 203, 178, 245, 189, 267],
            backgroundColor: '#10b981'
          }, {
            label: 'アクティブユーザー',
            data: [890, 967, 1034, 1156, 1203, 1247],
            backgroundColor: '#6366f1'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top'
            }
          }
        }
      });
      
      // Category Chart
      const categoryCtx = document.getElementById('categoryChart');
      this.categoryChart = new Chart(categoryCtx, {
        type: 'doughnut',
        data: {
          labels: ['掃除', '買い物', '配達', 'ペットケア', '修理'],
          datasets: [{
            data: [35, 25, 20, 12, 8],
            backgroundColor: [
              '#10b981',
              '#3b82f6',
              '#f59e0b',
              '#8b5cf6',
              '#ef4444'
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
      
      // Geographic Chart
      const geoCtx = document.getElementById('geographicChart');
      this.geographicChart = new Chart(geoCtx, {
        type: 'bar',
        data: {
          labels: ['東京', '大阪', '名古屋', '福岡', '札幌', '仙台'],
          datasets: [{
            label: 'ユーザー数',
            data: [456, 234, 178, 123, 89, 67],
            backgroundColor: '#7c3aed'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          }
        }
      });
    },
    
    updateCharts() {
      // Update chart data based on selected period
      // This would typically fetch new data from API
      
      if (this.revenueChart) {
        this.revenueChart.update();
      }
      if (this.userGrowthChart) {
        this.userGrowthChart.update();
      }
      if (this.categoryChart) {
        this.categoryChart.update();
      }
      if (this.geographicChart) {
        this.geographicChart.update();
      }
    },
    
    startRealTimeUpdates() {
      setInterval(() => {
        if (this.autoUpdate) {
          // Update real-time stats
          this.realTimeStats.currentUsers = Math.floor(Math.random() * 20) + 80;
          this.realTimeStats.tasksInProgress = Math.floor(Math.random() * 30) + 140;
          this.realTimeStats.todayRevenue += Math.floor(Math.random() * 5000);
          this.lastUpdated = new Date().toLocaleTimeString('ja-JP');
        }
      }, 5000);
    },
    
    async refreshData() {
      await this.loadAnalytics();
    },
    
    toggleAutoUpdate() {
      this.autoUpdate = !this.autoUpdate;
      if (this.autoUpdate) {
        toastr.success('自動更新を有効にしました');
      } else {
        toastr.info('自動更新を無効にしました');
      }
    },
    
    exportChart(chartType) {
      // Simulate chart export
      const chartNames = {
        revenue: '収益推移',
        users: 'ユーザー成長',
        categories: 'タスクカテゴリ',
        geographic: '地域別利用状況'
      };
      
      toastr.success(`${chartNames[chartType]}チャートをエクスポートしました`);
    },
    
    exportTable() {
      // Generate CSV data
      const headers = ['指標', '現在値', '前期比', '目標値', '達成率', 'トレンド'];
      const rows = this.performanceMetrics.map(metric => [
        metric.name,
        metric.current,
        metric.change + '%',
        metric.target,
        metric.achievement + '%',
        metric.trend === 'up' ? '上昇' : (metric.trend === 'down' ? '下降' : '安定')
      ]);
      
      const csv = [headers, ...rows]
        .map(row => row.map(field => `"${field}"`).join(','))
        .join('\n');
      
      // Download CSV
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', 'performance_metrics.csv');
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      toastr.success('パフォーマンス指標をエクスポートしました');
    },
    
    scheduleReport() {
      Swal.fire({
        title: '定期レポート設定',
        html: `
          <div class="text-left space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">レポート頻度</label>
              <select id="report-frequency" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                <option value="daily">毎日</option>
                <option value="weekly">毎週</option>
                <option value="monthly">毎月</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">送信先メールアドレス</label>
              <input id="report-email" type="email" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="admin@taskhelper.com">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">レポート内容</label>
              <div class="space-y-2">
                <label class="flex items-center">
                  <input type="checkbox" checked class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                  <span class="ml-2 text-sm">収益データ</span>
                </label>
                <label class="flex items-center">
                  <input type="checkbox" checked class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                  <span class="ml-2 text-sm">ユーザー分析</span>
                </label>
                <label class="flex items-center">
                  <input type="checkbox" class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                  <span class="ml-2 text-sm">パフォーマンス指標</span>
                </label>
              </div>
            </div>
          </div>
        `,
        showCancelButton: true,
        confirmButtonText: '設定保存',
        cancelButtonText: 'キャンセル',
        confirmButtonColor: '#7c3aed'
      }).then((result) => {
        if (result.isConfirmed) {
          toastr.success('定期レポートを設定しました');
        }
      });
    }
  }
}

// Configure Toastr
toastr.options = {
  "closeButton": true,
  "progressBar": true,
  "positionClass": "toast-top-right",
  "timeOut": "4000"
};
</script>

</body>
</html>