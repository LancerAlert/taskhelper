<!DOCTYPE html>
<html lang="ja" class="scroll-smooth">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ログイン - TaskHelper | 近所の信頼できる代行サービス</title>
  
  <!-- CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Suppress Tailwind CDN production warning for development
    if (typeof tailwind !== 'undefined') {
      tailwind.config = { devtools: false };
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- CSS Libraries -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  
  <!-- Additional UI Libraries -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.10.1/sweetalert2.min.css" rel="stylesheet">
  
  
  <!-- Custom CSS -->
  <style>
    .error-field {
      border-color: #dc2626 !important;
      background-color: #fef2f2 !important;
    }
    
    .success-field {
      border-color: #10b981 !important;
      background-color: #f0fdf4 !important;
    }
  </style>
  
</head>
<body class="bg-gradient-to-br from-gray-50 to-blue-50 min-h-screen" style="font-family: Inter, sans-serif;">

<!-- Navigation -->
<nav class="bg-white shadow-sm fixed top-0 left-0 right-0 z-50">
  <div class="max-w-7xl mx-auto px-4">
    <div class="flex items-center h-16">
      <!-- Logo -->
      <div class="flex items-center space-x-2">
        <i class="fas fa-hands-helping text-2xl text-blue-600" aria-hidden="true"></i>
        <span class="text-xl font-bold text-gray-900">TaskHelper</span>
      </div>
      
      <!-- Desktop Menu (centered) -->
      <div class="hidden md:flex items-center space-x-8 mx-auto">
        <a href="../index.html" class="text-gray-700 hover:text-blue-600 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2 focus:rounded px-2 py-1 no-underline">ホーム</a>
        <a href="/task/list" class="text-gray-700 hover:text-blue-600 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2 focus:rounded px-2 py-1 no-underline">依頼一覧</a>
        <a href="/task/create" class="text-gray-700 hover:text-blue-600 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2 focus:rounded px-2 py-1 no-underline">依頼投稿</a>
        <a href="/user/profile" class="text-gray-700 hover:text-blue-600 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2 focus:rounded px-2 py-1 no-underline">プロフィール</a>
        <a href="/task/my" class="text-gray-700 hover:text-blue-600 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2 focus:rounded px-2 py-1 no-underline">マイタスク</a>
      </div>
      
      <!-- Auth Buttons -->
      <div class="hidden md:flex items-center space-x-3">
        <a href="/auth/login" class="border border-blue-600 text-blue-600 px-6 py-2 rounded-lg font-semibold hover:bg-blue-50 transition-colors focus:outline-none focus:ring-4 focus:ring-blue-300" style="border: 1px solid #2563eb !important;">ログイン</a>
        <a href="/auth/register" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-700 transition-colors focus:outline-none focus:ring-4 focus:ring-blue-300">始める</a>
      </div>
      
      <!-- Mobile Menu Button -->
      <div class="md:hidden ml-auto">
        <button id="mobile-menu-button" class="text-gray-700 hover:text-blue-600 p-2 transition-all duration-300 ease-in-out" aria-expanded="false">
          <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path id="menu-icon" class="transition-opacity duration-300" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
            <path id="close-icon" class="transition-opacity duration-300 opacity-0" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
    </div>
    
    <!-- Mobile Menu -->
    <div id="mobile-menu" class="hidden md:hidden pb-4 transition-all duration-300 ease-in-out transform">
      <div class="flex flex-col space-y-2">
        <a href="../index.html" class="block px-3 py-2 text-gray-700 hover:text-blue-600 hover:bg-gray-50 rounded focus:outline-none focus:ring-2 focus:ring-blue-400">ホーム</a>
        <a href="/task/list" class="block px-3 py-2 text-gray-700 hover:text-blue-600 hover:bg-gray-50 rounded focus:outline-none focus:ring-2 focus:ring-blue-400">依頼一覧</a>
        <a href="/task/create" class="block px-3 py-2 text-gray-700 hover:text-blue-600 hover:bg-gray-50 rounded focus:outline-none focus:ring-2 focus:ring-blue-400">依頼投稿</a>
        <a href="/user/profile" class="block px-3 py-2 text-gray-700 hover:text-blue-600 hover:bg-gray-50 rounded focus:outline-none focus:ring-2 focus:ring-blue-400">プロフィール</a>
        <a href="/task/my" class="block px-3 py-2 text-gray-700 hover:text-blue-600 hover:bg-gray-50 rounded focus:outline-none focus:ring-2 focus:ring-blue-400">マイタスク</a>
        <hr class="my-3">
        <div class="flex gap-2 justify-center">
          <a href="/auth/login" class="border border-blue-600 text-blue-600 px-4 py-2 rounded-lg font-semibold hover:bg-blue-50 text-center transition-colors focus:outline-none focus:ring-4 focus:ring-blue-300" style="border: 1px solid #2563eb !important;">ログイン</a>
          <a href="/auth/register" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 text-center transition-colors focus:outline-none focus:ring-4 focus:ring-blue-300">始める</a>
        </div>
      </div>
    </div>
  </div>
</nav>

<!-- Main Content -->
<section class="bg-gradient-to-r from-blue-500 to-purple-600 text-white py-20 pt-32" aria-labelledby="login-title">
  <div class="flex items-center justify-center px-4 sm:px-6">
    <div class="max-w-md w-full space-y-6 sm:space-y-8">
      <!-- Header -->
      <div class="text-center">
        <h1 id="login-title" class="text-3xl sm:text-4xl font-bold mb-4">
          おかえりなさい
        </h1>  
        <p class="text-lg text-blue-100">
          TaskHelper アカウントにログイン
        </p>
        <div class="w-20 h-1 bg-white mx-auto mt-4 rounded-full"></div>
      </div>

      <!-- Login Form -->
      <div class="bg-white rounded-2xl shadow-lg p-6 sm:p-8 space-y-6">
      <form id="loginForm" class="space-y-6" novalidate>
        <!-- 基本情報 -->
        <fieldset class="space-y-5">
          <legend class="sr-only">ログイン情報</legend>
          
          <div class="space-y-1">
            <label for="email" class="block text-sm font-medium text-gray-700">メールアドレス</label>
            <div class="relative">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="fas fa-envelope text-gray-400 text-sm" aria-hidden="true"></i>
              </div>
              <input type="email" id="email" name="email" required autocomplete="username"
                     maxlength="254" minlength="5"
                     class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl bg-gray-50/50 focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 placeholder-gray-400"
                     placeholder="your@email.com">
            </div>
            <p id="emailError" class="text-xs mt-1 text-red-500 hidden"></p>
          </div>

          <div class="space-y-1">
            <label for="password" class="block text-sm font-medium text-gray-700">パスワード</label>
            <div class="relative">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="fas fa-lock text-gray-400 text-sm" aria-hidden="true"></i>
              </div>
              <input type="password" id="password" name="password" required autocomplete="off"
                     maxlength="128" minlength="6"
                     class="w-full pl-10 pr-12 py-3 border border-gray-300 rounded-xl bg-gray-50/50 focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 placeholder-gray-400"
                     placeholder="パスワードを入力">
              <button type="button" id="togglePassword" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-blue-600 transition-colors duration-200" aria-label="パスワードを表示/非表示" title="パスワードを表示">
                <i class="fas fa-eye text-sm" aria-hidden="true"></i>
              </button>
            </div>
            <p id="passwordError" class="text-xs mt-1 text-red-500 hidden"></p>
          </div>
        </fieldset>

        <!-- Options -->
        <div class="flex items-center justify-between">
          <label class="flex items-center cursor-pointer group">
            <input type="checkbox" id="rememberMe" name="rememberMe" class="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-2 focus:ring-blue-500 transition-all duration-200">
            <span class="ml-2 text-sm text-gray-600 group-hover:text-gray-700 transition-colors">ログインを記憶</span>
          </label>
          
          <button type="button" id="forgotPasswordLink" class="text-sm text-blue-600 hover:text-blue-700 transition-colors duration-200" title="パスワードリセット">
            パスワードを忘れた場合
          </button>
        </div>

        <!-- Submit Button -->
        <button type="submit" id="loginBtn" 
                class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-3 px-4 rounded-xl font-semibold hover:from-blue-700 hover:to-indigo-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98]">
          ログイン
        </button>
        
        <!-- Divider -->
        <div class="relative my-6">
          <div class="absolute inset-0 flex items-center">
            <div class="w-full border-t border-gray-200"></div>
          </div>
          <div class="relative flex justify-center text-sm">
            <span class="px-3 bg-white text-gray-500">または</span>
          </div>
        </div>

        <!-- Social Login -->
        <div class="grid grid-cols-2 gap-3">
          <!-- LINE Login -->
          <button type="button" class="group flex items-center justify-center py-3 px-4 bg-green-500 hover:bg-green-600 rounded-xl text-white transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98]" id="lineLogin" title="LINEでログイン">
            <i class="fab fa-line text-white text-lg group-hover:scale-110 transition-transform duration-200" aria-hidden="true"></i>
            <span class="ml-2 text-sm font-medium">LINE</span>
          </button>
          
          <!-- Yahoo Japan Login -->
          <button type="button" class="group flex items-center justify-center py-3 px-4 bg-red-600 hover:bg-red-700 rounded-xl text-white transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98]" id="yahooLogin" title="Yahoo! JAPAN IDでログイン">
            <i class="fab fa-yahoo text-white text-lg group-hover:scale-110 transition-transform duration-200" aria-hidden="true"></i>
            <span class="ml-2 text-sm font-medium">Yahoo!</span>
          </button>
        </div>
        
        <!-- Additional Social Login -->
        <div class="grid grid-cols-3 gap-3 mt-3">
          <button type="button" class="group flex items-center justify-center py-3 px-4 border border-gray-300 rounded-xl bg-white hover:bg-gray-50 hover:border-gray-400 transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98]" id="googleLogin" title="Googleアカウントでログイン">
            <i class="fab fa-google text-red-500 text-lg group-hover:scale-110 transition-transform duration-200" aria-hidden="true"></i>
          </button>
          
          <button type="button" class="group flex items-center justify-center py-3 px-4 border border-gray-300 rounded-xl bg-black hover:bg-gray-800 transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98]" id="twitterLogin" title="X(Twitter)でログイン">
            <i class="fab fa-x-twitter text-white text-lg group-hover:scale-110 transition-transform duration-200" aria-hidden="true"></i>
          </button>
          
          <button type="button" class="group flex items-center justify-center py-3 px-4 border border-gray-300 rounded-xl bg-black hover:bg-gray-800 text-white transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98]" id="appleLogin" title="Apple IDでログイン">
            <i class="fab fa-apple text-white text-lg group-hover:scale-110 transition-transform duration-200" aria-hidden="true"></i>
          </button>
        </div>
        
        <!-- Sign up prompt -->
        <div class="text-center mt-6 pt-6 border-t border-gray-100">
          <p class="text-sm text-gray-600">
            アカウントをお持ちでないですか？
            <a href="/auth/register" class="text-blue-600 hover:text-blue-700 font-medium hover:underline transition-colors ml-1">
              始める
            </a>
          </p>
        </div>
      </form>
    </div>

    </div>
  </div>
</section>

<!-- パスワード忘れモーダル -->
<div id="forgotPasswordModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50" aria-hidden="true">
  <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8 max-w-md w-full mx-4 sm:mx-6">
    <div class="text-center mb-6 sm:mb-8">
      <div class="mx-auto w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center mb-4">
        <i class="fas fa-key text-2xl text-white" aria-hidden="true"></i>
      </div>
      <h3 class="text-2xl font-bold text-gray-900 mb-2">パスワードをリセット</h3>
      <p class="text-gray-600 leading-relaxed">メールアドレスを入力してください。リセット用のリンクをお送りします。</p>
    </div>
    
    <form id="resetPasswordForm" class="space-y-5 sm:space-y-6">
      <div>
        <label for="resetEmail" class="block text-sm font-semibold text-gray-800 mb-2">メールアドレス</label>
        <div class="relative">
          <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
            <i class="fas fa-envelope text-gray-400" aria-hidden="true"></i>
          </div>
          <input type="email" id="resetEmail" name="resetEmail" required autocomplete="username"
                 maxlength="254" minlength="5"
                 class="w-full pl-12 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors bg-white"
                 placeholder="your@email.com">
        </div>
      </div>
      
      <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3">
        <button type="button" id="cancelReset" class="flex-1 py-3 border-2 border-gray-200 bg-white/80 backdrop-blur-sm text-gray-800 rounded-xl font-semibold hover:bg-white hover:border-gray-300 hover:shadow-md transition-all duration-200">
          キャンセル
        </button>
        <button type="submit" id="sendResetBtn" class="flex-1 py-3 border-2 border-gray-200 bg-white/80 backdrop-blur-sm text-gray-800 rounded-xl font-semibold hover:bg-white hover:border-gray-300 hover:shadow-md transition-all duration-200">
          送信
        </button>
      </div>
      
      <div id="resetMessage" class="text-sm text-center hidden" aria-live="polite"></div>
    </form>
  </div>
</div>


<!-- Footer -->
<footer class="bg-gray-900 text-white py-12">
  <div class="max-w-7xl mx-auto px-4">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
      <!-- Brand Section -->
      <div>
        <div class="flex items-center space-x-2 mb-4">
          <i class="fas fa-hands-helping text-2xl text-blue-500" aria-hidden="true"></i>
          <span class="text-xl font-bold">TaskHelper</span>
        </div>
        <p class="text-gray-400">近所の方々と一緒に信頼できる代行サービス</p>
      </div>
      
      <!-- Services Section -->
      <div>
        <h4 class="font-semibold mb-4">サービス</h4>
        <ul class="space-y-2 text-gray-400">
          <li><a href="/task/list?category=shopping" class="hover:text-white transition-colors">買い物代行</a></li>
          <li><a href="/task/list?category=cleaning" class="hover:text-white transition-colors">清掃サービス</a></li>
          <li><a href="/task/list?category=delivery" class="hover:text-white transition-colors">配達・運搬</a></li>
          <li><a href="/task/list?category=petcare" class="hover:text-white transition-colors">ペットケア</a></li>
        </ul>
      </div>
      
      <!-- Support Section -->
      <div>
        <h4 class="font-semibold mb-4">サポート</h4>
        <ul class="space-y-2 text-gray-400">
          <li><a href="#" class="hover:text-white transition-colors">ヘルプセンター</a></li>
          <li><a href="#" class="hover:text-white transition-colors">お問い合わせ</a></li>
          <li><a href="#" class="hover:text-white transition-colors">利用規約</a></li>
          <li><a href="#" class="hover:text-white transition-colors">プライバシーポリシー</a></li>
        </ul>
      </div>
      
      <!-- Follow Section -->
      <div>
        <h4 class="font-semibold mb-4">フォロー</h4>
        <div class="flex space-x-4">
          <a href="#" class="text-gray-400 hover:text-white transition-colors" aria-label="Twitter">
            <i class="fab fa-twitter text-xl"></i>
          </a>
          <a href="#" class="text-gray-400 hover:text-white transition-colors" aria-label="Facebook">
            <i class="fab fa-facebook text-xl"></i>
          </a>
          <a href="#" class="text-gray-400 hover:text-white transition-colors" aria-label="Instagram">
            <i class="fab fa-instagram text-xl"></i>
          </a>
        </div>
      </div>
    </div>
    
    <!-- Copyright Section -->
    <div class="border-t border-gray-800 mt-8 pt-8 text-center text-gray-400">
      <p>&copy; 2025 <span lang="en">TaskHelper</span>. <span lang="en">All rights reserved</span>.</p>
    </div>
  </div>
</footer>

<!-- JS Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.10.1/sweetalert2.all.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  
  // Mobile menu functionality
  const mobileMenuButton = document.getElementById('mobile-menu-button');
  const mobileMenu = document.getElementById('mobile-menu');
  
  if (mobileMenuButton && mobileMenu) {
    mobileMenuButton.addEventListener('click', function() {
      const isExpanded = this.getAttribute('aria-expanded') === 'true';
      this.setAttribute('aria-expanded', !isExpanded);
      mobileMenu.classList.toggle('hidden');
      
      // Toggle menu/close icons
      const menuIcon = document.getElementById('menu-icon');
      const closeIcon = document.getElementById('close-icon');
      if (menuIcon && closeIcon) {
        menuIcon.classList.toggle('opacity-0');
        closeIcon.classList.toggle('opacity-0');
      }
    });
  }
  
  // Dynamic title management for SPA readiness
  function updatePageTitle(title) {
    document.title = title;
    // Also update meta description if needed
    const metaDescription = document.querySelector('meta[name="description"]');
    if (metaDescription) {
      switch(title) {
        case 'ログイン - TaskHelper | 近所の信頼できる代行サービス':
          metaDescription.setAttribute('content', 'TaskHelper にログインして、信頼できる近所の代行サービスをご利用ください。');
          break;
        case 'パスワードリセット - TaskHelper':
          metaDescription.setAttribute('content', 'TaskHelper のパスワードをリセットして、アカウントにアクセスしてください。');
          break;
      }
    }
  }
  
  // Set initial title
  updatePageTitle('ログイン - TaskHelper | 近所の信頼できる代行サービス');
  
  // Export for global use
  window.TaskHelper = window.TaskHelper || {};
  window.TaskHelper.updatePageTitle = updatePageTitle;
  

// Check for saved login state
function checkSavedLoginState() {
  const rememberedEmail = localStorage.getItem('taskhelper_user_email');
  const sessionEmail = sessionStorage.getItem('taskhelper_user_email');
  
  if (rememberedEmail || sessionEmail) {
    const email = rememberedEmail || sessionEmail;
    const role = localStorage.getItem('taskhelper_user_role') || sessionStorage.getItem('taskhelper_user_role');
    
    // Auto-fill email if remembered
    if (rememberedEmail) {
      document.getElementById('email').value = email;
      document.getElementById('rememberMe').checked = true;
    }
    
    // If user is already logged in, show option to continue
    if (sessionEmail || rememberedEmail) {
      const loginForm = document.querySelector('.bg-white.rounded-2xl.shadow-lg');
      const existingSession = document.createElement('div');
      existingSession.className = 'bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6';
      existingSession.innerHTML = `
        <div class="flex items-center justify-between">
          <div class="flex items-center">
            <i class="fas fa-user-circle text-blue-600 text-xl mr-3"></i>
            <div>
              <p class="text-sm font-medium text-blue-900">${email} としてログイン中</p>
              <p class="text-xs text-blue-700">続行しますか？</p>
            </div>
          </div>
          <div class="flex space-x-2">
            <button type="button" id="continueLogin" class="px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition-colors">
              続行
            </button>
            <button type="button" id="clearLogin" class="px-3 py-1 bg-gray-200 text-gray-700 text-xs rounded hover:bg-gray-300 transition-colors">
              別のアカウント
            </button>
          </div>
        </div>
      `;
      
      loginForm.insertBefore(existingSession, loginForm.firstChild);
      
      // Continue with existing login
      document.getElementById('continueLogin').addEventListener('click', function() {
        const redirectUrl = new URLSearchParams(window.location.search).get('redirect') || 
                           (role === 'admin' ? '/admin' : role === 'helper' ? '/helper-dashboard' : '/dashboard');
        window.location.href = redirectUrl;
      });
      
      // Clear saved login
      document.getElementById('clearLogin').addEventListener('click', function() {
        localStorage.removeItem('taskhelper_remember');
        localStorage.removeItem('taskhelper_user_email');
        localStorage.removeItem('taskhelper_user_role');
        sessionStorage.removeItem('taskhelper_user_email');
        sessionStorage.removeItem('taskhelper_user_role');
        location.reload();
      });
    }
  }
}

checkSavedLoginState();

// Restore remember me checkbox state
const rememberMeCheckbox = document.getElementById('rememberMe');
const savedRememberMe = localStorage.getItem('taskhelper_remember_preference');
if (savedRememberMe === 'true') {
  rememberMeCheckbox.checked = true;
}

// Save remember me preference when changed
rememberMeCheckbox.addEventListener('change', function() {
  localStorage.setItem('taskhelper_remember_preference', this.checked.toString());
});

// Password toggle functionality
document.getElementById('togglePassword').addEventListener('click', function() {
  const passwordInput = document.getElementById('password');
  const icon = this.querySelector('i');
  
  const isPassword = passwordInput.type === 'password';
  passwordInput.type = isPassword ? 'text' : 'password';
  
  // Use classList.toggle for cleaner icon switching
  icon.classList.toggle('fa-eye', !isPassword);
  icon.classList.toggle('fa-eye-slash', isPassword);
  
  const newLabel = isPassword ? 'パスワードを非表示' : 'パスワードを表示';
  this.setAttribute('aria-label', newLabel);
  this.setAttribute('title', newLabel);
});

// Enter key login functionality
document.getElementById('email').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') {
    e.preventDefault();
    document.getElementById('loginBtn').click();
  }
});

document.getElementById('password').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') {
    e.preventDefault();
    document.getElementById('loginBtn').click();
  }
});

// Configure Toastr
toastr.options = {
  "closeButton": true,
  "progressBar": true,
  "positionClass": "toast-top-right",
  "timeOut": "4000"
};

// Simple debounce function
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// Caps Lock detection with vanilla JS debounce
const checkCapsLock = debounce(function(e) {
  const isCapsLock = e.getModifierState && e.getModifierState('CapsLock');
  const passwordError = document.getElementById('passwordError');
  if (isCapsLock) {
    passwordError.textContent = 'Caps Lockがオンになっています。';
    passwordError.classList.remove('hidden');
  } else if (!this.value) {
    passwordError.classList.add('hidden');
  }
}, 100);

document.getElementById('password').addEventListener('keyup', checkCapsLock);

// Simple form validation
function validateForm() {
  const email = document.getElementById('email');
  const password = document.getElementById('password');
  const emailError = document.getElementById('emailError');
  const passwordError = document.getElementById('passwordError');
  
  let isValid = true;
  
  // Clear previous errors
  emailError.classList.add('hidden');
  passwordError.classList.add('hidden');
  email.classList.remove('error-field');
  password.classList.remove('error-field');
  
  // Email validation
  if (!email.value.trim()) {
    emailError.textContent = 'メールアドレスを入力してください。';
    emailError.classList.remove('hidden');
    email.classList.add('error-field');
    isValid = false;
  } else if (!email.validity.valid) {
    emailError.textContent = '有効なメールアドレスを入力してください。';
    emailError.classList.remove('hidden');
    email.classList.add('error-field');
    isValid = false;
  }
  
  // Password validation
  if (!password.value) {
    passwordError.textContent = 'パスワードを入力してください。';
    passwordError.classList.remove('hidden');
    password.classList.add('error-field');
    isValid = false;
  } else if (password.value.length < 6) {
    passwordError.textContent = 'パスワードは6文字以上で入力してください。';
    passwordError.classList.remove('hidden');
    password.classList.add('error-field');
    isValid = false;
  }
  
  return isValid;
}

// Form submission
document.getElementById('loginForm').addEventListener('submit', function(event) {
  event.preventDefault();
  
  if (!validateForm()) {
    return;
  }
    
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    const loginBtn = document.getElementById('loginBtn');
    const loginError = document.getElementById('loginError');
    const loginSuccess = document.getElementById('loginSuccess');
    
    // Clear previous messages
    loginError.classList.add('hidden');
    loginSuccess.classList.add('hidden');
    
    // Simulate login process
    loginBtn.disabled = true;
    loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ログイン中...';
    
    setTimeout(() => {
      // Simulate login success (in real app, this would be an API call)
      const rememberMe = document.getElementById('rememberMe').checked;
      
      // Test accounts with different roles
      const testAccounts = {
        'user@example.com': { password: 'password123', role: 'user', redirect: '/dashboard' },
        'helper@example.com': { password: 'helper123', role: 'helper', redirect: '/helper-dashboard' },
        'admin@example.com': { password: 'admin123', role: 'admin', redirect: '/admin' }
      };
      
      const account = testAccounts[email];
      
      if (account && password === account.password) {
        // Save login state if remember me is checked
        if (rememberMe) {
          localStorage.setItem('taskhelper_remember', 'true');
          localStorage.setItem('taskhelper_user_email', email);
          localStorage.setItem('taskhelper_user_role', account.role);
        } else {
          // Save to sessionStorage for current session only
          sessionStorage.setItem('taskhelper_user_email', email);
          sessionStorage.setItem('taskhelper_user_role', account.role);
        }
        
        const roleText = account.role === 'admin' ? '管理者' : account.role === 'helper' ? 'ヘルパー' : 'ユーザー';
        
        // Use SweetAlert2 for success message
        Swal.fire({
          icon: 'success',
          title: 'ログイン成功！',
          text: `${roleText}としてログインしました`,
          timer: 2000,
          showConfirmButton: false
        });
        
        setTimeout(() => {
          const urlParams = new URLSearchParams(window.location.search);
          const redirectUrl = urlParams.get('redirect') || account.redirect;
          window.location.href = redirectUrl;
        }, 1500);
      } else {
        // Use Toastr for error message
        toastr.error('メールアドレスまたはパスワードが正しくありません。');
        
        // Restore remember me checkbox after failure
        const rememberMeCheckbox = document.getElementById('rememberMe');
        if (rememberMeCheckbox.checked) {
          rememberMeCheckbox.checked = true;
        }
        
        loginBtn.disabled = false;
        loginBtn.innerHTML = '<i class="fas fa-sign-in-alt mr-2" aria-hidden="true"></i>ログイン';
      }
    }, 2000);
  });

// Forgot password modal
const forgotPasswordLink = document.getElementById('forgotPasswordLink');
const forgotPasswordModal = document.getElementById('forgotPasswordModal');
const cancelReset = document.getElementById('cancelReset');

forgotPasswordLink.addEventListener('click', function(e) {
  e.preventDefault();
  forgotPasswordModal.classList.remove('hidden');
  forgotPasswordModal.classList.add('flex');
  forgotPasswordModal.setAttribute('aria-hidden', 'false');
  document.getElementById('resetEmail').focus();
  // Update title for better UX
  if (window.TaskHelper && window.TaskHelper.updatePageTitle) {
    window.TaskHelper.updatePageTitle('パスワードリセット - TaskHelper');
  }
});

cancelReset.addEventListener('click', function() {
  forgotPasswordModal.classList.add('hidden');
  forgotPasswordModal.classList.remove('flex');
  forgotPasswordModal.setAttribute('aria-hidden', 'true');
  // Restore original title
  if (window.TaskHelper && window.TaskHelper.updatePageTitle) {
    window.TaskHelper.updatePageTitle('ログイン - TaskHelper | 近所の信頼できる代行サービス');
  }
});

// Close modal on background click
forgotPasswordModal.addEventListener('click', function(e) {
  if (e.target === this) {
    cancelReset.click();
  }
});

// Close modal on ESC key press
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape' && !forgotPasswordModal.classList.contains('hidden')) {
    cancelReset.click();
  }
});

// Reset password form validation
document.getElementById('resetPasswordForm').addEventListener('submit', function(event) {
  event.preventDefault();
  
  const resetEmail = document.getElementById('resetEmail');
  if (!resetEmail.value.trim() || !resetEmail.validity.valid) {
    Swal.fire({
      icon: 'error',
      title: 'エラー',
      text: '有効なメールアドレスを入力してください。'
    });
    return;
  }
    
    const sendResetBtn = document.getElementById('sendResetBtn');
    const resetMessage = document.getElementById('resetMessage');
    
    sendResetBtn.disabled = true;
    sendResetBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>送信中...';
    
    setTimeout(() => {
      Swal.fire({
        icon: 'success',
        title: '送信完了',
        text: 'パスワードリセット用のリンクをメールでお送りしました。',
        timer: 3000,
        showConfirmButton: false
      });
      
      sendResetBtn.disabled = false;
      sendResetBtn.innerHTML = '<i class="fas fa-paper-plane mr-2" aria-hidden="true"></i>送信';
      
      setTimeout(() => {
        cancelReset.click();
        document.getElementById('resetEmail').value = '';
      }, 1500);
    }, 2000);
  });

// Environment detection utility
function isProductionEnvironment() {
  const hostname = window.location.hostname;
  const isDevelopment = hostname === 'localhost' || 
                       hostname === '127.0.0.1' || 
                       hostname.includes('.local') ||
                       hostname.includes('dev.') ||
                       window.location.protocol === 'file:';
  return !isDevelopment;
}

// Social login handling with environment detection
const socialLogins = {
  line: {
    name: 'LINE',
    url: '/oauth/line',
    color: '#00C300'
  },
  yahoo: {
    name: 'Yahoo! JAPAN',
    url: '/oauth/yahoo',
    color: '#FF0033'
  },
  google: {
    name: 'Google',
    url: '/oauth/google',
    color: '#DB4437'
  },
  twitter: {
    name: 'X (Twitter)',
    url: '/oauth/twitter',
    color: '#000000'
  },
  apple: {
    name: 'Apple',
    url: '/oauth/apple',
    color: '#000000'
  }
};

// LINE Login
document.getElementById('lineLogin').addEventListener('click', function(e) {
  handleSocialLogin('line');
});

// Yahoo Japan Login
document.getElementById('yahooLogin').addEventListener('click', function(e) {
  handleSocialLogin('yahoo');
});

// Google Login
document.getElementById('googleLogin').addEventListener('click', function(e) {
  handleSocialLogin('google');
});

// Twitter Login
document.getElementById('twitterLogin').addEventListener('click', function(e) {
  handleSocialLogin('twitter');
});

// Apple Login
document.getElementById('appleLogin').addEventListener('click', function(e) {
  handleSocialLogin('apple');
});

// Social login handler function
function handleSocialLogin(provider) {
  const loginInfo = socialLogins[provider];
  
  if (!isProductionEnvironment()) {
    Swal.fire({
      icon: 'info',
      title: '開発環境',
      text: `${loginInfo.name} ログインはシミュレーションです。\n実際の環境では ${loginInfo.url} にリダイレクトされます。`,
      confirmButtonText: 'OK',
      confirmButtonColor: loginInfo.color
    });
  } else {
    // In production, redirect to OAuth provider
    window.location.href = loginInfo.url;
  }
}

});
</script>

</body>
</html>